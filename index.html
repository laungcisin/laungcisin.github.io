<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh_cn">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh_cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>Hexo</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh_cn">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2100/01/01/1-redis高可用服务缓存架构/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2100/01/01/1-redis高可用服务缓存架构/" itemprop="url">1-redis高可用服务缓存架构</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2100-01-01T08:08:08+08:00">
                2100-01-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-高并发、高可用复杂系统中的缓存架构有哪些东西？"><a href="#1-高并发、高可用复杂系统中的缓存架构有哪些东西？" class="headerlink" title="1. 高并发、高可用复杂系统中的缓存架构有哪些东西？"></a>1. 高并发、高可用复杂系统中的缓存架构有哪些东西？</h2><ol>
<li>复杂的缓存架构需要支撑高并发、高可用</li>
</ol>
<h2 id="2-课程内容-商品详情页的架构？"><a href="#2-课程内容-商品详情页的架构？" class="headerlink" title="2. 课程内容-商品详情页的架构？"></a>2. 课程内容-商品详情页的架构？</h2><ol>
<li>商品详情页系统架构 -&gt; 缓存架构 -&gt; 高并发技术+解决方案+架构 -&gt; 高可用技术+解决方案+架构</li>
</ol>
<h2 id="3-小型电商网站的商品详情页的页面静态化架构及其缺陷？"><a href="#3-小型电商网站的商品详情页的页面静态化架构及其缺陷？" class="headerlink" title="3. 小型电商网站的商品详情页的页面静态化架构及其缺陷？"></a>3. 小型电商网站的商品详情页的页面静态化架构及其缺陷？</h2><ol>
<li><p>商品详情页的系统架构 -&gt; 缓存架构 -&gt; 高并发 -&gt; 高可用<br> 小型电商网站架构方案：页面静态化的方案<br> html模板页面：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">	&lt;title&gt;</span><br><span class="line">		&lt;style css&gt;</span><br><span class="line">		&lt;javascript&gt;</span><br><span class="line">	&lt;/title&gt;</span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		商品名称：#&#123;productName&#125;</span><br><span class="line">		商品价格：#&#123;productPrice&#125;</span><br><span class="line">		商品描述：#&#123;productDesc&#125;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p> 数据存在数据库中 -&gt; 模板的渲染</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">	&lt;title&gt;</span><br><span class="line">		&lt;style css&gt;</span><br><span class="line">		&lt;javascript&gt;</span><br><span class="line">	&lt;/title&gt;</span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		商品名称：iphon7 plus（玫瑰）</span><br><span class="line">		商品价格：5299.50	</span><br><span class="line">		商品描述：这是最好的手机，大降价了</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p> 模板改变了，这个模板对应的所有数据，全部重新渲染一遍。小网站，页面很少，很实用，非常简单。<br> 大网站，模板上亿，重新渲染，不靠谱。</p>
</li>
</ol>
<p><img src="/2100/01/01/1-redis高可用服务缓存架构/3-小型电商静态化架构.png" alt="3-小型电商静态化架构" title="小型电商静态化架构"></p>
<h2 id="4-大型电商网站的异步多级缓存构建-nginx数据本地化动态渲染的架构"><a href="#4-大型电商网站的异步多级缓存构建-nginx数据本地化动态渲染的架构" class="headerlink" title="4. 大型电商网站的异步多级缓存构建+nginx数据本地化动态渲染的架构"></a>4. 大型电商网站的异步多级缓存构建+nginx数据本地化动态渲染的架构</h2><p><img src="/2100/01/01/1-redis高可用服务缓存架构/4-大型电商网站的详情页架构.png" alt="4-大型电商网站的详情页架构" title="大型电商网站的详情页架构"></p>
<pre><code>架构解析：

1. 用户访问页面

2. nignx服务器
    2.1 nignx服务器从本地获取数据，如果获取到，渲染html模板；
    没有，执行第3步；

3. redis集群
    3.1 redis集群从本地获取数据，如果获取到，返回给nignx服务器，nignx服务器将数据写入本地缓存；
    没有，执行第4步；

4. ehcache缓存
    4.1 ehcache缓存从本地获取数据，如果获取到，返回给redis集群，redis集群写入本地；
        redis集群将数据返回给nignx服务器，nignx服务器将数据写入本地缓存；
        没有，执行第5步；

5. 去源头获取数据，再一步一步往回执行，写入本地。
</code></pre><hr>
<h2 id="5-redis的重要性–首先要掌握redis"><a href="#5-redis的重要性–首先要掌握redis" class="headerlink" title="5. redis的重要性–首先要掌握redis"></a>5. redis的重要性–首先要掌握redis</h2><pre><code>支撑高并发、高可用、海量数据、备份恢复的redis的重要性
1. redis架构支持高并发、高可用、海量数据、备份并随时可以恢复。

2. 解决各种各样高并发场景下的缓存面临的难题，缓存架构中不断的引入各种解决方案和技术，解决高并发的问题

3. 解决各种各样缓存架构本身面临的高可用的问题，缓存架构中引入各种解决方案和技术，解决高可用的问题
</code></pre><h2 id="6-准备好CentOS集群"><a href="#6-准备好CentOS集群" class="headerlink" title="6. 准备好CentOS集群"></a>6. 准备好CentOS集群</h2><h2 id="7-单机版redis的安装以及redis生产环境启动方案"><a href="#7-单机版redis的安装以及redis生产环境启动方案" class="headerlink" title="7. 单机版redis的安装以及redis生产环境启动方案"></a>7. 单机版redis的安装以及redis生产环境启动方案</h2><h2 id="8-redis持久化机对于生产环境中的灾难恢复的意义"><a href="#8-redis持久化机对于生产环境中的灾难恢复的意义" class="headerlink" title="8. redis持久化机对于生产环境中的灾难恢复的意义"></a>8. redis持久化机对于生产环境中的灾难恢复的意义</h2><p><img src="/2100/01/01/1-redis高可用服务缓存架构/8-redis持久化的意义.png" alt="8-redis持久化的意义" title="redis持久化的意义"></p>
<pre><code>redis持久化的意义：在于数据备份，以便于故障恢复。
如果没有持久化的话，redis遇到灾难性故障的时候，就会丢失所有的数据。
如果通过持久化将数据备份在磁盘上，然后定期同步和备份到其它存储上，
那么就可以保证数据不全部丢失，还是可以恢复一部分数据回来的。
</code></pre><h2 id="9-redis的RDB和AOF两种持久化机制的工作原理"><a href="#9-redis的RDB和AOF两种持久化机制的工作原理" class="headerlink" title="9. redis的RDB和AOF两种持久化机制的工作原理"></a>9. redis的RDB和AOF两种持久化机制的工作原理</h2><pre><code>持久化主要是做灾难恢复，数据恢复，可归类到高可用中。

数据恢复的意义：
    &gt;假如redis集群宕机了，redis就不可用了，首要事情是让redis变得可用，尽快变得可用。
    &gt;此时重启redis，尽快对外提供服务。
    &gt;如果没做数据备份，redis启动了，没有可恢复的数据，redis无法对外提供服务。
    &gt;此时大量的请求过来，缓存全部无法命中，请求全部查询数据库，造成数据库宕机，造成缓存雪崩问题。

redis持久化：RDB，AOF。
    &gt;`RDB：Redis Database`
    &gt;`AOF：Append Only File`
</code></pre><p><img src="/2100/01/01/1-redis高可用服务缓存架构/9-1-RDB和AOF的介绍.png" alt="9-1-RDB和AOF的介绍" title="RDB和AOF的介绍"></p>
<p><img src="/2100/01/01/1-redis高可用服务缓存架构/9-2-AOF-rewrite原理剖析.png" alt="9-2-AOF-rewrite原理剖析" title="AOF-rewrite原理剖析">        </p>
<h2 id="10-redis的RDB和AOF两种持久化机制的优劣势对比"><a href="#10-redis的RDB和AOF两种持久化机制的优劣势对比" class="headerlink" title="10. redis的RDB和AOF两种持久化机制的优劣势对比"></a>10. redis的RDB和AOF两种持久化机制的优劣势对比</h2><h3 id="10-1-RDB持久化机制的优点"><a href="#10-1-RDB持久化机制的优点" class="headerlink" title="10.1 RDB持久化机制的优点"></a>10.1 RDB持久化机制的优点</h3><ol>
<li><p>RDB会生成多个数据文件，每个数据文件代表了某一个时刻中redis的数据，这种多个数据文件的方式，非常适合做冷备，<br>可以将这些数据文件发送到一些远程的安全存储上去，以预定好的备份策略来定期备份redis中的数据。<br>RDB也可以做冷备，生成多个文件，每个文件都代表了某一个时刻的完整的数据快照。<br>AOF也可以做冷备，只有一个文件，但是你可以，每隔一定时间，去copy一份这个文件出来。<br>RDB做冷备，优势在哪儿呢？由redis去控制固定时长生成快照文件的事情，比较方便;<br>AOF，还需要自己写一些脚本去做这个事情，各种定时。<br>RDB数据做冷备，在最坏的情况下，提供数据恢复的时候，速度比AOF快</p>
</li>
<li><p>RDB对redis对外提供的读写服务，影响非常小，可以让redis保持高性能，因为redis主进程只需要fork一个子进程，<br>让子进程执行磁盘IO操作来进行RDB持久化即可。<br>RDB，每次写，都是直接写redis内存，只是在一定的时候，才会将数据写入磁盘中。<br>AOF，每次都是要写文件的，虽然可以快速写入os cache中，但是还是有一定的时间开销的,速度肯定比RDB略慢一些。</p>
</li>
<li><p>相对于AOF持久化机制来说，直接基于RDB数据文件来重启和恢复redis进程，更加快速。<br>AOF，存放的指令日志，做数据恢复的时候，其实是要回放和执行所有的指令日志，来恢复出来内存中的所有数据的。<br>RDB，就是一份数据文件，恢复的时候，直接加载到内存中即可。</p>
</li>
</ol>
<p>结合上述优点，RDB特别适合做冷备份。</p>
<h3 id="10-2-RDB持久化机制的缺点"><a href="#10-2-RDB持久化机制的缺点" class="headerlink" title="10.2 RDB持久化机制的缺点"></a>10.2 RDB持久化机制的缺点</h3><p><img src="/2100/01/01/1-redis高可用服务缓存架构/10-RDB丢失数据的问题.png" alt="10-RDB丢失数据的问题" title="RDB丢失数据的问题">    </p>
<ol>
<li><p>如果想要在redis故障时，尽可能少的丢失数据，那么RDB没有AOF好。一般来说，RDB数据快照文件，都是每隔5分钟，<br>或者更长时间生成一次，这个时候就得接受一旦redis进程宕机，那么会丢失最近5分钟的数据。<br>这个问题，也是rdb最大的缺点，就是不适合做第一优先的恢复方案，如果你依赖RDB做第一优先恢复方案，会导致数据丢失的比较多。</p>
</li>
<li><p>RDB每次在fork子进程来执行RDB快照数据文件生成的时候，如果数据文件特别大，可能会导致对客户端提供的服务暂停数毫秒，<br>或者甚至数秒。一般不要让RDB的间隔太长，否则每次生成的RDB文件太大了，对redis本身的性能可能会有影响的。</p>
</li>
</ol>
<h3 id="10-3-AOF持久化机制的优点"><a href="#10-3-AOF持久化机制的优点" class="headerlink" title="10.3 AOF持久化机制的优点"></a>10.3 AOF持久化机制的优点</h3><ol>
<li>AOF可以更好的保护数据不丢失，一般AOF会每隔1秒，通过一个后台线程执行一次fsync操作，最多丢失1秒钟的数据。</li>
</ol>
<p>每隔1秒，就执行一次fsync操作，保证os cache中的数据写入磁盘中。</p>
<p>redis进程挂了，最多丢掉1秒钟的数据</p>
<ol>
<li>AOF日志文件以append-only模式写入，所以没有任何磁盘寻址的开销，写入性能非常高，而且文件不容易破损，<br>即使文件尾部破损，也很容易修复</li>
</ol>
<ol>
<li><p>AOF日志文件即使过大的时候，出现后台重写操作，也不会影响客户端的读写。<br>因为在rewrite log的时候，会对其中的指导进行压缩，创建出一份需要恢复数据的最小日志出来。<br>再创建新日志文件的时候，老的日志文件还是照常写入。当新的merge后的日志文件ready的时候，再交换新老日志文件即可。</p>
</li>
<li><p>AOF日志文件的命令通过非常可读的方式进行记录，这个特性非常适合做灾难性的误删除的紧急恢复。<br>比如某人不小心用flushall命令清空了所有数据，只要这个时候后台rewrite还没有发生，<br>那么就可以立即拷贝AOF文件，将最后一条flushall命令给删了，然后再将该AOF文件放回去，<br>就可以通过恢复机制，自动恢复所有数据</p>
</li>
</ol>
<h3 id="10-4-AOF持久化机制的缺点"><a href="#10-4-AOF持久化机制的缺点" class="headerlink" title="10.4 AOF持久化机制的缺点"></a>10.4 AOF持久化机制的缺点</h3><ol>
<li><p>对于同一份数据来说，AOF日志文件通常比RDB数据快照文件更大</p>
</li>
<li><p>AOF开启后，支持的写QPS会比RDB支持的写QPS低，因为AOF一般会配置成每秒fsync一次日志文件，当然，每秒一次fsync，<br>性能也还是很高的。如果你要保证一条数据都不丢，也是可以的，AOF的fsync设置成没写入一条数据，<br>fsync一次，那就完蛋了，redis的QPS大降</p>
</li>
<li><p>以前AOF发生过bug，就是通过AOF记录的日志，进行数据恢复的时候，<br>没有恢复一模一样的数据出来。所以说，类似AOF这种较为复杂的基于命令日志/merge/回放的方式，<br>比基于RDB每次持久化一份完整的数据快照文件的方式，更加脆弱一些，容易有bug。<br>不过AOF就是为了避免rewrite过程导致的bug，因此每次rewrite并不是基于旧的指令日志进行merge的，<br>而是基于当时内存中的数据进行指令的重新构建，这样健壮性会好很多。</p>
</li>
<li><p>唯一的比较大的缺点，其实就是做数据恢复的时候，会比较慢，还有做冷备，定期的备份，不太方便，<br>可能要自己手写复杂的脚本去做，做冷备不太合适</p>
</li>
</ol>
<h3 id="10-5-RDB和AOF到底该如何选择"><a href="#10-5-RDB和AOF到底该如何选择" class="headerlink" title="10.5 RDB和AOF到底该如何选择"></a>10.5 RDB和AOF到底该如何选择</h3><ol>
<li><p>不要仅仅使用RDB，因为那样会导致你丢失很多数据</p>
</li>
<li><p>也不要仅仅使用AOF，因为那样有两个问题，<br>第一，你通过AOF做冷备，没有RDB做冷备，来的恢复速度更快;<br>第二，RDB每次简单粗暴生成数据快照，更加健壮，可以避免AOF这种复杂的备份和恢复机制的bug</p>
</li>
<li><p>综合使用AOF和RDB两种持久化机制，用AOF来保证数据不丢失，作为数据恢复的第一选择;<br>用RDB来做不同程度的冷备，在AOF文件都丢失或损坏不可用的时候，还可以使用RDB来进行快速的数据恢复</p>
</li>
</ol>
<h2 id="11-redis的RDB持久化配置以及数据恢复实验"><a href="#11-redis的RDB持久化配置以及数据恢复实验" class="headerlink" title="11. redis的RDB持久化配置以及数据恢复实验"></a>11. redis的RDB持久化配置以及数据恢复实验</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2100/01/01/2-redis高可用服务缓存架构-软件安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2100/01/01/2-redis高可用服务缓存架构-软件安装/" itemprop="url">2-redis高可用服务缓存架构-软件安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2100-01-01T08:08:07+08:00">
                2100-01-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="7-1-安装单机版redis"><a href="#7-1-安装单机版redis" class="headerlink" title="7.1 安装单机版redis"></a>7.1 安装单机版redis</h2><h3 id="7-1-1-安装单机版redis"><a href="#7-1-1-安装单机版redis" class="headerlink" title="7.1.1 安装单机版redis"></a>7.1.1 安装单机版redis</h3><ol>
<li><p>更改<code>/usr/local</code>的<code>group</code>和<code>user</code>权限</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown bigdata:bigdata /usr/local -R</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装<code>tcl</code>。本文安装<code>tcl8.6.1</code>版本</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cd /home/bigdata/software/</span><br><span class="line">wget http://downloads.sourceforge.net/tcl/tcl8.6.1-src.tar.gz</span><br><span class="line">chmod 777 tcl8.6.1-src.tar.gz</span><br><span class="line">tar -zxvf /home/bigdata/software/tcl8.6.1-src.tar.gz -C /export/servers</span><br><span class="line">cd /export/servers/tcl8.6.1/unix/</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装<code>redis</code>。本文安装<code>redis-3.2.8</code>版本</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cd /home/bigdata/software/</span><br><span class="line">wget http://download.redis.io/releases/redis-3.2.8.tar.gz</span><br><span class="line">chmod 777 redis-3.2.8.tar.gz</span><br><span class="line">tar -zxvf /home/bigdata/software/redis-3.2.8.tar.gz  -C /export/servers</span><br><span class="line">cd /export/servers</span><br><span class="line">ln -s redis-3.2.8 redis</span><br><span class="line">cd /export/servers/redis</span><br><span class="line">make &amp;&amp; make test &amp;&amp; make install</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="7-1-2-redis的生产环境启动方案（非root用户启动）"><a href="#7-1-2-redis的生产环境启动方案（非root用户启动）" class="headerlink" title="7.1.2 redis的生产环境启动方案（非root用户启动）"></a>7.1.2 <code>redis</code>的生产环境启动方案（非<code>root</code>用户启动）</h3><ol>
<li><p>将 <code>/export/servers/redis/utils/redis_init_script</code>脚本拷贝至<code>/etc/init.d</code> ，重命名为<code>redis_6379</code>，<code>6379</code>是<code>redis</code>实例监听的端口号。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#root用户执行</span><br><span class="line">cp -r /export/servers/redis/utils/redis_init_script /etc/init.d</span><br><span class="line">cd /etc/init.d</span><br><span class="line">mv redis_init_script redis_6379</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建三个目录，一个存放<code>redis</code>配置文件，一个存放<code>redis</code>的持久化文件，一个存放<code>redis</code>日志</p>
<ul>
<li><p>创建存放<code>redis</code>的配置文件目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#非root用户执行</span><br><span class="line">mkdir -p /export/data/redis/conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建存放<code>redis</code>的持久化文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#非root用户执行</span><br><span class="line">mkdir -p /export/data/redis/6379</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建存放<code>redis</code>日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#非root用户执行</span><br><span class="line">mkdir -p /export/data/redis/logs</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>修改 <code>/etc/init.d/redis_6379</code> 脚本内容</p>
<ul>
<li>修改 <code>/etc/init.d/redis_6379</code>的<code>REDISPORT</code>为<code>6379</code>，默认是<code>6379</code>，可不修改</li>
<li>设置 <code>PIDFILE=/export/data/redis/redis_${REDISPORT}.pid</code></li>
<li>设置 <code>CONF=&quot;/export/data/redis/conf/${REDISPORT}.conf&quot;</code></li>
</ul>
</li>
</ol>
<ol start="4">
<li>修改<code>redis</code>配置文件，并重命名<br> 将<code>/export/servers/redis/redis.conf</code>拷贝至<code>/export/data/redis/conf</code>，并重命名成<code>6379.conf</code> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#非root用户执行</span><br><span class="line">cp -r /export/servers/redis/redis.conf /export/data/redis/conf</span><br><span class="line">cd /export/data/redis/conf</span><br><span class="line">mv redis.conf 6379.conf</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>修改配置</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">配置项</th>
<th>配置值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">daemonize</td>
<td>yes</td>
<td>让redis以daemon进程运行</td>
</tr>
<tr>
<td style="text-align:left">pidfile</td>
<td>/export/data/redis/redis_6379.pid</td>
<td>设置redis的pid文件位置</td>
</tr>
<tr>
<td style="text-align:left">port</td>
<td>6379</td>
<td>设置redis的监听端口号</td>
</tr>
<tr>
<td style="text-align:left">dir</td>
<td>/export/data/redis/6379</td>
<td>设置持久化文件的存储位置</td>
</tr>
<tr>
<td style="text-align:left">bind</td>
<td>127.0.0.1 192.168.33.61</td>
<td>设置绑定地址，使用redis-cli命令时， 使用-h参数时， 要指定ip地址</td>
</tr>
</tbody>
</table>
<ol start="5">
<li><p>启动<code>redis</code>，关闭<code>redis</code></p>
<ul>
<li><p><code>root</code>用户启动<code>redis</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#用root用户执行</span><br><span class="line">cd /etc/init.d</span><br><span class="line">chmod 777 redis_6379</span><br><span class="line">./redis_6379 start</span><br></pre></td></tr></table></figure>
</li>
<li><p>非<code>root</code>用户启动<code>redis</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/redis-server /export/data/redis/conf/6379.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>非<code>root</code>用户关闭<code>redis</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/redis-cli -p 7200 shutdown</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>确认<code>redis</code>进程是否启动</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep redis</span><br></pre></td></tr></table></figure>
</li>
<li><p>让<code>redis</code>跟随系统启动<br> 修改<code>/etc/init.d/redis_6379</code>脚本<br> 在<code>/etc/init.d/redis_6379</code>脚本中，最上面，加入下面两行注释</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#用root用户执行</span><br><span class="line">vi /etc/init.d/redis_6379</span><br><span class="line"></span><br><span class="line"># 添加下面两行注释</span><br><span class="line"># chkconfig:   2345 90 10</span><br><span class="line"># description:  Redis is a persistent key-value database</span><br><span class="line"></span><br><span class="line">#执行以下命令，设置开机服务自动启动</span><br><span class="line">cd /etc/init.d/</span><br><span class="line">chkconfig redis_6379 on</span><br><span class="line"></span><br><span class="line">#如果要关闭自动启动，执行以下命令</span><br><span class="line">cd /etc/init.d/</span><br><span class="line">chkconfig redis_6379 off</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>redis cli</code>的使用</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#连接本机的6379端口停止redis进程</span><br><span class="line">redis-cli SHUTDOWN</span><br><span class="line"></span><br><span class="line">redis-cli -h 192.168.33.61 -p 6379</span><br><span class="line"></span><br><span class="line">#指定要连接的ip和端口号</span><br><span class="line">redis-cli -h 127.0.0.1 -p 6379 SHUTDOWN</span><br><span class="line"></span><br><span class="line">#ping redis的端口，看是否正常</span><br><span class="line">redis-cli PING</span><br><span class="line"></span><br><span class="line">redis-cli，进入交互式命令行</span><br><span class="line"></span><br><span class="line">#设置键值</span><br><span class="line">SET k1 v1</span><br><span class="line"></span><br><span class="line">#获取值</span><br><span class="line">GET k1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="7-2-搭建redis-cluster集群"><a href="#7-2-搭建redis-cluster集群" class="headerlink" title="7.2 搭建redis-cluster集群"></a>7.2 搭建<code>redis-cluster</code>集群</h2><h3 id="7-2-1-安装集群前的准备"><a href="#7-2-1-安装集群前的准备" class="headerlink" title="7.2.1 安装集群前的准备"></a>7.2.1 安装集群前的准备</h3><p><strong>*CentOS安装redis集群提示</strong><code>redis requires ruby version 2.2.2</code><strong>的解决方案*</strong></p>
<ol>
<li><p>安装RVM</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#具体RVM安装命令地址，参考：http://rvm.io/</span><br><span class="line">gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB </span><br><span class="line"></span><br><span class="line">curl -sSL https://get.rvm.io | bash -s stable</span><br><span class="line">source /usr/local/rvm/scripts/rvm</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看rvm库中已知的ruby版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm list known</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装一个ruby版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm install 2.5.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用一个ruby版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm use 2.5.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置默认版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm use 2.5.1 --default</span><br></pre></td></tr></table></figure>
</li>
<li><p>卸载一个已知版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rvm remove 1.8.1</span><br><span class="line">rvm remove 2.3.4</span><br><span class="line">rvm remove 2.4.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看ruby版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby --version</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装redis</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install redis</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="7-2-2-安装redis集群"><a href="#7-2-2-安装redis集群" class="headerlink" title="7.2.2 安装redis集群"></a>7.2.2 安装<code>redis</code>集群</h3><blockquote>
<p>集群配置3台机器，一台机器配置一主一从。<br>redis的配置文件：<code>/export/data/redis/conf/700*.conf</code><br>redis的持久化文件夹：<code>/export/data/redis/700*</code></p>
</blockquote>
<p><strong>3台机器：</strong></p>
<blockquote>
<p>192.168.33.61<br>192.168.33.62<br>192.168.33.63</p>
</blockquote>
<ol>
<li><p>创建目录<br>在3台机器上执行如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /export/data/redis-cluster</span><br><span class="line">mkdir -p /export/data/redis-cluster-log</span><br><span class="line">mkdir -p /export/data/redis/7001</span><br><span class="line">mkdir -p /export/data/redis/7002</span><br><span class="line">mkdir -p /export/data/redis/7003</span><br><span class="line">mkdir -p /export/data/redis/7004</span><br><span class="line">mkdir -p /export/data/redis/7005</span><br><span class="line">mkdir -p /export/data/redis/7006</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>/export/data/redis-cluster</code>为集群目录<br><code>/export/data/redis-cluster-log</code>为集群日志目录</p>
</blockquote>
</li>
<li><p>准备配置文件<br><strong>在1台机器上执行如下命令，准备好配置文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cp -r /export/servers/redis/redis.conf /export/data/redis/conf/7001.conf</span><br><span class="line">cp -r /export/servers/redis/redis.conf /export/data/redis/conf/7002.conf</span><br><span class="line">cp -r /export/servers/redis/redis.conf /export/data/redis/conf/7003.conf</span><br><span class="line">cp -r /export/servers/redis/redis.conf /export/data/redis/conf/7004.conf</span><br><span class="line">cp -r /export/servers/redis/redis.conf /export/data/redis/conf/7005.conf</span><br><span class="line">cp -r /export/servers/redis/redis.conf /export/data/redis/conf/7006.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置  </p>
</li>
</ol>
<hr>
<p><strong>机器端口分配情况：</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">机器ip</th>
<th>分配的端口号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">192.168.33.61</td>
<td>7001 ~ 7002</td>
</tr>
<tr>
<td style="text-align:left">192.168.33.62</td>
<td>7003 ~ 7004</td>
</tr>
<tr>
<td style="text-align:left">192.168.33.63</td>
<td>7005 ~ 7006</td>
</tr>
</tbody>
</table>
<hr>
<p>根据如下表格，并根据机器ip、端口分配情况，修改<strong><code>/export/data/redis/conf/700*.conf</code></strong>相应配置  </p>
<table>
<thead>
<tr>
<th style="text-align:left">配置项</th>
<th>配置值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">port</td>
<td>700*</td>
<td>设置redis的监听端口号</td>
</tr>
<tr>
<td style="text-align:left">cluster-enabled</td>
<td>yes</td>
<td>开启集群</td>
</tr>
<tr>
<td style="text-align:left">cluster-config-file</td>
<td>/export/data/redis-cluster/nodes-700*.conf</td>
<td>集群配置文件</td>
</tr>
<tr>
<td style="text-align:left">cluster-node-timeout</td>
<td>15000</td>
<td>超时时长</td>
</tr>
<tr>
<td style="text-align:left">daemonize</td>
<td>yes</td>
<td>让redis以daemon进程运行</td>
</tr>
<tr>
<td style="text-align:left">pidfile</td>
<td>/export/data/redis/redis_700*.pid</td>
<td>设置redis的pid文件位置</td>
</tr>
<tr>
<td style="text-align:left">dir</td>
<td>/export/data/redis/700*</td>
<td>设置持久化文件的存储位置</td>
</tr>
<tr>
<td style="text-align:left">logfile</td>
<td>/export/data/redis-cluster-log/700*.log</td>
<td>设置集群日志持久化文件的存储位置</td>
</tr>
<tr>
<td style="text-align:left">bind</td>
<td>192.168.33.6*</td>
<td>设置绑定地址，最好不要绑定127.0.0.1，否则集群启动不起来</td>
</tr>
<tr>
<td style="text-align:left">appendonly</td>
<td>yes</td>
<td>开启AOF功能</td>
</tr>
</tbody>
</table>
<hr>
<p>配置完后，将配置文件分发到另外两台机器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -r /export/servers/redis/700* bigdata@192.168.33.62:/export/data/redis/conf/</span><br><span class="line">scp -r /export/servers/redis/700* bigdata@192.168.33.63:/export/data/redis/conf/</span><br></pre></td></tr></table></figure></p>
<ol>
<li><p>准备生产环境的启动脚本<br>在<code>/etc/init.d</code>目录下，准备6个启动脚本，分别为: <code>redis_7001, redis_7002, redis_7003, redis_7004, redis_7005, redis_7006</code>，在每个启动脚本内，都修改对应的端口号。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"># chkconfig:   2345 90 10</span><br><span class="line"># description:  Redis is a persistent key-value database</span><br><span class="line">#</span><br><span class="line"># Simple Redis init.d script conceived to work on Linux systems</span><br><span class="line"># as it does use of the /proc filesystem.</span><br><span class="line"></span><br><span class="line">#redis服务器监听的端口，根据实际情况修改</span><br><span class="line">REDISPORT=700*</span><br><span class="line">#EXEC=/usr/local/bin/redis-server</span><br><span class="line">#CLIEXEC=/usr/local/bin/redis-cli</span><br><span class="line"></span><br><span class="line">#PIDFILE=/var/run/redis_$&#123;REDISPORT&#125;.pid</span><br><span class="line">#CONF=&quot;/etc/redis/$&#123;REDISPORT&#125;.conf&quot;</span><br><span class="line"></span><br><span class="line">#服务端所处位置，在make install后默认存放于`/usr/local/bin/redis-server`，如果未make install则需要修改该路径，下同。</span><br><span class="line">EXEC=/usr/local/bin/redis-server</span><br><span class="line">#客户端位置</span><br><span class="line">CLIEXEC=/usr/local/bin/redis-cli</span><br><span class="line"></span><br><span class="line">#Redis的PID文件位置</span><br><span class="line">PIDFILE=/export/data/redis/redis_$&#123;REDISPORT&#125;.pid</span><br><span class="line">#配置文件位置，需要修改</span><br><span class="line">CONF=&quot;/export/data/redis/conf/$&#123;REDISPORT&#125;.conf&quot;</span><br><span class="line"></span><br><span class="line">case &quot;$1&quot; in</span><br><span class="line">    start)</span><br><span class="line">        if [ -f $PIDFILE ]</span><br><span class="line">        then</span><br><span class="line">                echo &quot;$PIDFILE exists, process is already running or crashed&quot;</span><br><span class="line">        else</span><br><span class="line">                echo &quot;Starting Redis server...&quot;</span><br><span class="line">                $EXEC $CONF</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        if [ ! -f $PIDFILE ]</span><br><span class="line">        then</span><br><span class="line">                echo &quot;$PIDFILE does not exist, process is not running&quot;</span><br><span class="line">        else</span><br><span class="line">                PID=$(cat $PIDFILE)</span><br><span class="line">                echo &quot;Stopping ...&quot;</span><br><span class="line">                $CLIEXEC -p $REDISPORT shutdown</span><br><span class="line">                while [ -x /proc/$&#123;PID&#125; ]</span><br><span class="line">                do</span><br><span class="line">                    echo &quot;Waiting for Redis to shutdown ...&quot;</span><br><span class="line">                    sleep 1</span><br><span class="line">                done</span><br><span class="line">                echo &quot;Redis stopped&quot;</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &quot;Please use start or stop as first argument&quot;</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>
</li>
<li><p>在3台机器上，启动6个redis实例 </p>
<blockquote>
<p><strong>如果有启动redis实例，先停止实例</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/redis-cli -p 7001 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -p 7002 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -p 7003 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -p 7004 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -p 7005 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -p 7006 shutdown</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>清理集群状态</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /export/data/redis-cluster/*</span><br><span class="line">rm -rf /export/data/redis-cluster-log/*</span><br><span class="line"></span><br><span class="line">rm -rf /export/data/redis/7001/*</span><br><span class="line">rm -rf /export/data/redis/7002/*</span><br><span class="line">rm -rf /export/data/redis/7003/*</span><br><span class="line">rm -rf /export/data/redis/7004/*</span><br><span class="line">rm -rf /export/data/redis/7005/*</span><br><span class="line">rm -rf /export/data/redis/7006/*</span><br><span class="line"></span><br><span class="line">rm -rf /export/data/redis/redis_700*.pid</span><br><span class="line"></span><br><span class="line">#在192.168.33.61机器上执行redis-trib.rb create，所以要在清理192.168.33.61上的配置</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7001 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7001 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7001 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7002 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7002 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7002 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7003 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7003 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7003 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7004 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7004 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7004 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7005 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7005 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7005 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7006 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7006 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7006 cluster reset</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>使用<code>flushall</code>和<code>cluster reset</code>命令，避免出现<code>ERR Slot 0 is already busy (Redis::CommandError)</code>错误</p>
</blockquote>
<blockquote>
<p><strong>192.168.33.61机器执行以下命令：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/redis-server /export/data/redis/conf/7001.conf</span><br><span class="line">/usr/local/bin/redis-server /export/data/redis/conf/7002.conf</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>192.168.33.62机器执行以下命令：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/redis-server /export/data/redis/conf/7003.conf</span><br><span class="line">/usr/local/bin/redis-server /export/data/redis/conf/7004.conf</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>192.168.33.63机器执行以下命令：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/redis-server /export/data/redis/conf/7005.conf</span><br><span class="line">/usr/local/bin/redis-server /export/data/redis/conf/7006.conf</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>查看redis实例启动日志：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /export/data/redis-cluster-log/700*</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>创建集群  </p>
<blockquote>
<p><strong>执行以下命令：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /export/servers/redis/src/redis-trib.rb /usr/local/bin</span><br><span class="line">redis-trib.rb create --replicas 1 192.168.33.61:7001 192.168.33.61:7002 192.168.33.62:7003 192.168.33.62:7004 192.168.33.63:7005 192.168.33.63:7006</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>–replicas 1: 每个master有1个slave</p>
</blockquote>
<blockquote>
<p><strong>如果出现以下错误：</strong><br>[ERR] Not all 16384 slots are covered by nodes，<br>执行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb fix 192.168.33.61:7001</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>查看集群状态：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 192.168.33.61 -c -p 7001 cluster nodes</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>设置开机启动  </p>
<blockquote>
<p>使用root用户执行<br><strong>192.168.33.61机器执行以下命令：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#执行以下命令，设置开机服务自动启动</span><br><span class="line">cd /etc/init.d/</span><br><span class="line">chkconfig redis_7001 on</span><br><span class="line">chkconfig redis_7002 on</span><br><span class="line"></span><br><span class="line">#如果要关闭自动启动，执行以下命令</span><br><span class="line">cd /etc/init.d/</span><br><span class="line">chkconfig redis_7001 off</span><br><span class="line">chkconfig redis_7002 off</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>192.168.33.62机器执行以下命令：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#执行以下命令，设置开机服务自动启动</span><br><span class="line">cd /etc/init.d/</span><br><span class="line">chkconfig redis_7003 on</span><br><span class="line">chkconfig redis_7004 on</span><br><span class="line"></span><br><span class="line">#如果要关闭自动启动，执行以下命令</span><br><span class="line">cd /etc/init.d/</span><br><span class="line">chkconfig redis_7003 off</span><br><span class="line">chkconfig redis_7004 off</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>192.168.33.63机器执行以下命令：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#执行以下命令，设置开机服务自动启动</span><br><span class="line">cd /etc/init.d/</span><br><span class="line">chkconfig redis_7005 on</span><br><span class="line">chkconfig redis_7006 on</span><br><span class="line"></span><br><span class="line">#如果要关闭自动启动，执行以下命令</span><br><span class="line">cd /etc/init.d/</span><br><span class="line">chkconfig redis_7005 off</span><br><span class="line">chkconfig redis_7006 off</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
<h2 id="11-redis的RDB持久化配置以及数据恢复实验"><a href="#11-redis的RDB持久化配置以及数据恢复实验" class="headerlink" title="11. redis的RDB持久化配置以及数据恢复实验"></a>11. redis的RDB持久化配置以及数据恢复实验</h2><h3 id="11-1-如何配置RDB持久化机制"><a href="#11-1-如何配置RDB持久化机制" class="headerlink" title="11.1 如何配置RDB持久化机制"></a>11.1 如何配置RDB持久化机制</h3><p>修改配置<br><code>/etc/init.d/redis.conf</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">save 60 1000</span><br></pre></td></tr></table></figure></p>
<p>每隔60s，如果有超过1000个key发生了变更，那么就生成一个新的dump.rdb文件，snapshotting，快照。</p>
<p>save可以设置多个</p>
<h3 id="11-2-RDB持久化机制的工作流程"><a href="#11-2-RDB持久化机制的工作流程" class="headerlink" title="11.2 RDB持久化机制的工作流程"></a>11.2 RDB持久化机制的工作流程</h3><ol>
<li>redis根据配置自己尝试去生成rdb快照文件</li>
<li>fork一个子进程出来</li>
<li>子进程尝试将数据dump到临时的rdb快照文件中</li>
<li>完成rdb快照文件的生成之后，就替换之前的旧的快照文件</li>
</ol>
<p>dump.rdb，每次生成一个新的快照，都会覆盖之前的老快照</p>
<hr>
<h3 id="11-3-基于RDB持久化机制的数据恢复实验"><a href="#11-3-基于RDB持久化机制的数据恢复实验" class="headerlink" title="11.3 基于RDB持久化机制的数据恢复实验"></a>11.3 基于RDB持久化机制的数据恢复实验</h3><ol>
<li><p><code>redis-cli SHUTDOWN</code>这种方式去停掉redis，其实是一种安全退出的模式，redis在退出的时候会将内存中的数据<br>立即生成一份完整的rdb快<code>/var/redis/6379/dump.rdb</code></p>
</li>
<li><p>在<code>redis</code>中再保存几条新的数据，用<code>kill -9</code>粗暴杀死<code>redis</code>进程，模拟<code>redis</code>故障异常退出，导致内存数据丢失的场景<br>这次就发现，redis进程异常被杀掉，数据没有进dump文件，几条最新的数据就丢失了</p>
</li>
<li><p>手动设置一个save检查点，save 5 1</p>
</li>
<li>写入几条数据，等待5秒钟，会发现自动进行了一次dump rdb快照，在dump.rdb中发现了数据</li>
<li>异常停掉redis进程，再重新启动redis，看刚才插入的数据还在</li>
</ol>
<p>rdb的手动配置检查点，以及rdb快照的生成，包括数据的丢失和恢复，全都演示过了</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2100/01/01/3-redis高可用服务缓存架构-软件启动/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2100/01/01/3-redis高可用服务缓存架构-软件启动/" itemprop="url">3-redis高可用服务缓存架构-软件启动</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2100-01-01T08:08:06+08:00">
                2100-01-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-单机启动redis集群"><a href="#1-单机启动redis集群" class="headerlink" title="1. 单机启动redis集群"></a>1. 单机启动redis集群</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#停止redis进程</span><br><span class="line">/usr/local/bin/redis-cli -h 192.168.33.61 -p 7001 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -h 192.168.33.61 -p 7002 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -h 192.168.33.61 -p 7003 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -h 192.168.33.61 -p 7004 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -h 192.168.33.61 -p 7005 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -h 192.168.33.61 -p 7006 shutdown</span><br><span class="line"></span><br><span class="line">#启动redis集群</span><br><span class="line">/usr/local/bin/redis-server /export/data/test-env-redis/redis/conf/7001.conf</span><br><span class="line">/usr/local/bin/redis-server /export/data/test-env-redis/redis/conf/7002.conf</span><br><span class="line">/usr/local/bin/redis-server /export/data/test-env-redis/redis/conf/7003.conf</span><br><span class="line">/usr/local/bin/redis-server /export/data/test-env-redis/redis/conf/7004.conf</span><br><span class="line">/usr/local/bin/redis-server /export/data/test-env-redis/redis/conf/7005.conf</span><br><span class="line">/usr/local/bin/redis-server /export/data/test-env-redis/redis/conf/7006.conf</span><br><span class="line"></span><br><span class="line">#查看redis集群启动日志</span><br><span class="line">cat /export/data/test-env-redis/redis-cluster-log/700*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#清理redis集群</span><br><span class="line">mkdir -p /export/data/test-env-redis/redis-cluster</span><br><span class="line">mkdir -p /export/data/test-env-redis/redis-cluster-log</span><br><span class="line">mkdir -p /export/data/test-env-redis/redis/7001</span><br><span class="line">mkdir -p /export/data/test-env-redis/redis/7002</span><br><span class="line">mkdir -p /export/data/test-env-redis/redis/7003</span><br><span class="line">mkdir -p /export/data/test-env-redis/redis/7004</span><br><span class="line">mkdir -p /export/data/test-env-redis/redis/7005</span><br><span class="line">mkdir -p /export/data/test-env-redis/redis/7006</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rm -rf /export/data/test-env-redis/redis-cluster/*</span><br><span class="line">rm -rf /export/data/test-env-redis/redis-cluster-log/*</span><br><span class="line"></span><br><span class="line">rm -rf /export/data/test-env-redis/redis/7001/*</span><br><span class="line">rm -rf /export/data/test-env-redis/redis/7002/*</span><br><span class="line">rm -rf /export/data/test-env-redis/redis/7003/*</span><br><span class="line">rm -rf /export/data/test-env-redis/redis/7004/*</span><br><span class="line">rm -rf /export/data/test-env-redis/redis/7005/*</span><br><span class="line">rm -rf /export/data/test-env-redis/redis/7006/*</span><br><span class="line">rm -rf /export/data/test-env-redis/redis/redis_700*.pid</span><br><span class="line"></span><br><span class="line">redis-cli -h 192.168.33.61 -p 7001 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7001 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7001 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7002 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7002 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7002 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7003 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7003 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7003 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7004 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7004 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7004 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7005 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7005 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7005 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7006 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7006 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7006 cluster reset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#拷贝命令至bin目录</span><br><span class="line">#cp /export/servers/redis/src/redis-trib.rb /usr/local/bin</span><br><span class="line"></span><br><span class="line">#创建集群</span><br><span class="line">redis-trib.rb create --replicas 1 192.168.33.61:7001 192.168.33.61:7002 192.168.33.61:7003 192.168.33.61:7004 192.168.33.61:7005 192.168.33.61:7006</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2099/12/31/storm集群安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2099/12/31/storm集群安装/" itemprop="url">storm集群安装并运行程序</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2099-12-31T00:00:05+08:00">
                2099-12-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h2><p> 在Nimbus和worker机器上安装<code>Java</code>和<code>Python</code>依赖包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#需安装Java7以上版本</span><br><span class="line">java -version</span><br><span class="line"></span><br><span class="line">#需安装python2.7以上版本</span><br><span class="line">python --version</span><br></pre></td></tr></table></figure></p>
<h2 id="解压storm安装包"><a href="#解压storm安装包" class="headerlink" title="解压storm安装包"></a>解压storm安装包</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf /home/bigdata/software/apache-storm-1.1.0.tar.gz -C /export/servers/</span><br><span class="line">cd /export/servers/</span><br><span class="line">rm -rf storm</span><br><span class="line">ln -s apache-storm-1.1.0 storm</span><br></pre></td></tr></table></figure>
<h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /export/servers/storm/conf/storm.yaml /export/servers/storm/conf/storm.yaml.bak</span><br><span class="line">vi /export/servers/storm/conf/storm.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#指定storm使用的zk集群</span><br><span class="line">storm.zookeeper.servers:</span><br><span class="line">     - &quot;bigdata01&quot;</span><br><span class="line">     - &quot;bigdata02&quot;</span><br><span class="line">     - &quot;bigdata03&quot;</span><br><span class="line"></span><br><span class="line">#指定storm本地目录</span><br><span class="line">storm.local.dir: &quot;/export/data/storm&quot;</span><br><span class="line"></span><br><span class="line">#用于配置主控节点的地址，可以配置多个</span><br><span class="line">nimbus.seeds: [&quot;192.168.33.61&quot;]</span><br><span class="line"></span><br><span class="line">#指定nimbus启动JVM最大可用内存大小</span><br><span class="line">nimbus.childopts: &quot;-Xmx1024m&quot;</span><br><span class="line"></span><br><span class="line">#指定supervisor启动JVM最大可用内存大小</span><br><span class="line">supervisor.childopts: &quot;-Xmx1024m&quot;</span><br><span class="line"></span><br><span class="line">#指定supervisor节点上，每个worker启动JVM最大可用内存大小</span><br><span class="line">worker.childopts: &quot;-Xmx768m&quot;</span><br><span class="line"></span><br><span class="line">#指定ui启动JVM最大可用内存大小，ui服务一般与nimbus同在一个节点上。</span><br><span class="line">ui.childopts: &quot;-Xmx768m&quot;</span><br><span class="line"></span><br><span class="line">#指定supervisor节点上，启动worker时对应的端口号，每个端口对应槽，每个槽位对应一个worker</span><br><span class="line">#指定每个机器上可以启动多少个worker，一个端口号代表一个worker</span><br><span class="line">supervisor.slots.ports:</span><br><span class="line">    - 6700</span><br><span class="line">    - 6701</span><br><span class="line">    - 6702</span><br><span class="line">    - 6703</span><br></pre></td></tr></table></figure>
<p><strong><em>设置环境变量</em></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#使用root用户执行</span><br><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">#Storm</span><br><span class="line">export STORM_HOME=/export/servers/storm</span><br><span class="line">export PATH=$PATH:$STORM_HOME/bin</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure></p>
<h2 id="分发安装包到其它台机器"><a href="#分发安装包到其它台机器" class="headerlink" title="分发安装包到其它台机器"></a>分发安装包到其它台机器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scp -r /export/servers/apache-storm-1.1.0 bigdata02:/export/servers</span><br><span class="line">scp -r /export/servers/apache-storm-1.1.0 bigdata03:/export/servers</span><br><span class="line"></span><br><span class="line">#然后分别在各机器上创建软连接，并设置环境变量</span><br><span class="line">cd /export/servers/</span><br><span class="line">ln -s apache-storm-1.1.0 storm</span><br></pre></td></tr></table></figure>
<p><strong><em>设置环境变量</em></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#使用root用户执行</span><br><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">#Storm</span><br><span class="line">export STORM_HOME=/export/servers/storm</span><br><span class="line">export PATH=$PATH:$STORM_HOME/bin</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure></p>
<h2 id="启动storm集群、ui界面、运行程序"><a href="#启动storm集群、ui界面、运行程序" class="headerlink" title="启动storm集群、ui界面、运行程序"></a>启动storm集群、ui界面、运行程序</h2><p><strong><em>启动前，先保证zookeeper集群已经启动</em></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#在主节点启动nimbus</span><br><span class="line">storm nimbus &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">#在所有机器启动supervisor</span><br><span class="line">storm supervisor &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">#在主节点启动ui</span><br><span class="line">storm ui &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">#在supervisor启动</span><br><span class="line">storm logviewer &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">#运行程序</span><br><span class="line">storm jar /home/bigdata/run-jar-dir/storm-0.0.1-SNAPSHOT.jar com.laungcisin.storm.WordCountTopology wordCountTopology</span><br><span class="line"></span><br><span class="line">#kill topology</span><br><span class="line">storm kill wordCountTopology</span><br></pre></td></tr></table></figure></p>
<h2 id="通过ui界面查看集群"><a href="#通过ui界面查看集群" class="headerlink" title="通过ui界面查看集群"></a>通过ui界面查看集群</h2><p>访问 <a href="http://192.168.33.61:8080" target="_blank" rel="noopener">http://192.168.33.61:8080</a> ，即可看到storm的ui界面。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2099/12/31/zookeeper-kafka集群的安装部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2099/12/31/zookeeper-kafka集群的安装部署/" itemprop="url">zookeeper-kafka集群的安装部署</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2099-12-31T00:00:04+08:00">
                2099-12-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="zookeeper集群搭建"><a href="#zookeeper集群搭建" class="headerlink" title="zookeeper集群搭建"></a>zookeeper集群搭建</h1><h2 id="解压文件"><a href="#解压文件" class="headerlink" title="解压文件"></a>解压文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf /home/bigdata/software/zookeeper-3.4.11.tar.gz -C /export/servers/</span><br><span class="line">cd /export/servers/</span><br><span class="line">ln -s zookeeper-3.4.11 zookeeper</span><br></pre></td></tr></table></figure>
<h2 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h2><h3 id="修改zookeeper数据目录和日志目录"><a href="#修改zookeeper数据目录和日志目录" class="headerlink" title="修改zookeeper数据目录和日志目录"></a>修改zookeeper数据目录和日志目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/zookeeper/conf</span><br><span class="line">cp zoo_sample.cfg zoo.cfg</span><br><span class="line">vi /export/servers/zookeeper/conf/zoo.cfg</span><br><span class="line"></span><br><span class="line">#zookeeper数据目录</span><br><span class="line">dataDir=/export/data/zookeeper/workdir/data</span><br><span class="line"></span><br><span class="line">#zookeeper日志目录</span><br><span class="line">dataLogDir=/export/data/zookeeper/workdir/log</span><br></pre></td></tr></table></figure>
<h3 id="设置zookeeper集群信息"><a href="#设置zookeeper集群信息" class="headerlink" title="设置zookeeper集群信息"></a>设置zookeeper集群信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vi /export/servers/zookeeper/conf/zoo.cfg</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">#设置集群信息,此处的bigdata0x可以用ip地址代替</span><br><span class="line">server.1=bigdata01:2888:3888</span><br><span class="line">server.2=bigdata02:2888:3888</span><br><span class="line">server.3=bigdata03:2888:3888</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#执行</span><br><span class="line">rm -rf /export/data/zookeeper/</span><br><span class="line"></span><br><span class="line">mkdir -p /export/data/zookeeper/workdir/data</span><br><span class="line">mkdir -p /export/data/zookeeper/workdir/log</span><br><span class="line"></span><br><span class="line">echo &quot;1&quot; &gt; /export/data/zookeeper/workdir/data/myid</span><br></pre></td></tr></table></figure>
<h3 id="将zookeeper拷贝到其它机器上"><a href="#将zookeeper拷贝到其它机器上" class="headerlink" title="将zookeeper拷贝到其它机器上"></a>将zookeeper拷贝到其它机器上</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#将zookeeper拷贝至bigdata02机器上</span><br><span class="line">scp -r /export/servers/zookeeper-3.4.11 bigdata@bigdata02:/export/servers</span><br><span class="line"></span><br><span class="line">#进入bigdata02机器执行以下命令</span><br><span class="line">mkdir -p /export/data/zookeeper/workdir/data</span><br><span class="line">echo &quot;2&quot; &gt; /export/data/zookeeper/workdir/data/myid</span><br><span class="line"></span><br><span class="line">#将zookeeper拷贝至bigdata03机器上</span><br><span class="line">scp -r /export/servers/zookeeper-3.4.11 bigdata@bigdata03:/export/servers</span><br><span class="line"></span><br><span class="line">#进入bigdata03机器执行以下命令</span><br><span class="line">mkdir -p /export/data/zookeeper/workdir/data</span><br><span class="line">echo &quot;3&quot; &gt; /export/data/zookeeper/workdir/data/myid</span><br></pre></td></tr></table></figure>
<h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#切换成root用户执行，修改profile文件</span><br><span class="line">vi /etc/profile</span><br><span class="line">#Zookeeper</span><br><span class="line">export ZOOKEEPER_HOME=/export/servers/zookeeper</span><br><span class="line">export PATH=$PATH:$&#123;ZOOKEEPER_HOME&#125;/bin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#使配置生效</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<h2 id="zk命令"><a href="#zk命令" class="headerlink" title="zk命令"></a>zk命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#启动时，切换成bigdata用户</span><br><span class="line">su bigdata</span><br><span class="line"></span><br><span class="line">#启动zookeeper</span><br><span class="line">zkServer.sh start</span><br><span class="line"></span><br><span class="line">#查看zookeeper状态</span><br><span class="line">zkServer.sh status</span><br></pre></td></tr></table></figure>
<h1 id="kafka集群搭建"><a href="#kafka集群搭建" class="headerlink" title="kafka集群搭建"></a>kafka集群搭建</h1><p>搭建kafka集群前，先保证zookeeper集群已搭建成功。</p>
<h2 id="解压文件-1"><a href="#解压文件-1" class="headerlink" title="解压文件"></a>解压文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf /home/bigdata/software/kafka_2.11-1.0.0.tgz -C /export/servers/</span><br><span class="line">cd /export/servers/</span><br><span class="line">ln -s kafka_2.11-1.0.0 kafka</span><br></pre></td></tr></table></figure>
<h2 id="修改配置-1"><a href="#修改配置-1" class="headerlink" title="修改配置"></a>修改配置</h2><h3 id="修改zookeeper数据目录和日志目录-1"><a href="#修改zookeeper数据目录和日志目录-1" class="headerlink" title="修改zookeeper数据目录和日志目录"></a>修改zookeeper数据目录和日志目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">cp /export/servers/kafka/config/server.properties /export/servers/kafka/config/server.properties.bak</span><br><span class="line">vi /export/servers/kafka/config/server.properties</span><br><span class="line"></span><br><span class="line">#根据实际情况修改</span><br><span class="line">#当前机器在集群中的唯一标识，和zookeeper的myid性质一样</span><br><span class="line">broker.id=0</span><br><span class="line"></span><br><span class="line">#当前kafka对外提供服务的端口默认是9092</span><br><span class="line">port=9092</span><br><span class="line"></span><br><span class="line">#这个参数默认是关闭的，在0.8.1有个bug，DNS解析问题，失败率的问题。</span><br><span class="line">host.name=192.168.33.61</span><br><span class="line"></span><br><span class="line">#这个是borker进行网络处理的线程数</span><br><span class="line">num.network.threads=3</span><br><span class="line"></span><br><span class="line">#这个是borker进行I/O处理的线程数</span><br><span class="line">num.io.threads=8</span><br><span class="line"></span><br><span class="line">#消息存放的目录，这个目录可以配置为&quot;,&quot;逗号分割的表达式，</span><br><span class="line">#上面的num.io.threads要大于这个目录的个数这个目录，</span><br><span class="line">#如果配置多个目录，新创建的topic他把消息持久化的地方是，当前以逗号分割的目录中，那个分区数最少就放那一个</span><br><span class="line">log.dirs=/export/data/kafka/logs</span><br><span class="line"></span><br><span class="line">#发送缓冲区buffer大小，数据不是一下子就发送的，先回存储到缓冲区了到达一定的大小后在发送，能提高性能</span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line"></span><br><span class="line">#kafka接收缓冲区大小，当数据到达一定大小后在序列化到磁盘</span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line"></span><br><span class="line">#这个参数是向kafka请求消息或者向kafka发送消息的请请求的最大数，这个值不能超过java的堆栈大小</span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line"></span><br><span class="line">#默认的分区数，一个topic默认1个分区数</span><br><span class="line">num.partitions=1</span><br><span class="line"></span><br><span class="line">#默认消息的最大持久化时间，168小时，7天</span><br><span class="line">log.retention.hours=168</span><br><span class="line"></span><br><span class="line">#消息保存的最大值5M</span><br><span class="line">message.max.byte=5242880</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#kafka保存消息的副本数，如果一个副本失效了，另一个还可以继续提供服务</span><br><span class="line">default.replication.factor=2</span><br><span class="line"></span><br><span class="line">#取消息的最大直接数</span><br><span class="line">replica.fetch.max.bytes=5242880</span><br><span class="line"></span><br><span class="line">#这个参数是：因为kafka的消息是以追加的形式落地到文件，当超过这个值的时候，kafka会新起一个文件</span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line"></span><br><span class="line">#每隔300000毫秒去检查上面配置的log失效时间（log.retention.hours=168 ），</span><br><span class="line">#到目录查看是否有过期的消息如果有，删除</span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line"></span><br><span class="line">#是否启用log压缩，一般不用启用，启用的话可以提高性能</span><br><span class="line">log.cleaner.enable=false</span><br><span class="line"></span><br><span class="line">#设置zookeeper的连接端口</span><br><span class="line">zookeeper.connect=bigdata01:2181,bigdata02:2181,bigdata03:2181</span><br><span class="line"></span><br><span class="line">#远程消费的话，配置此参数</span><br><span class="line">listeners=PLAINTEXT://192.168.33.61:9092</span><br></pre></td></tr></table></figure>
<h2 id="分发安装包"><a href="#分发安装包" class="headerlink" title="分发安装包"></a>分发安装包</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#将kafka安装包分发到其它机器上</span><br><span class="line">scp -r /export/servers/kafka_2.11-1.0.0 bigdata@bigdata02:/export/servers</span><br><span class="line">scp -r /export/servers/kafka_2.11-1.0.0 bigdata@bigdata03:/export/servers</span><br><span class="line"></span><br><span class="line">#然后分别在各机器上创建软连</span><br><span class="line">cd /export/servers/</span><br><span class="line">ln -s kafka_2.11-1.0.0 kafka</span><br></pre></td></tr></table></figure>
<h2 id="修改其它机器上的kafka配置"><a href="#修改其它机器上的kafka配置" class="headerlink" title="修改其它机器上的kafka配置"></a>修改其它机器上的kafka配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#修改其它机器的kafka配置信息</span><br><span class="line">vi /export/servers/kafka/config/server.properties</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">将broker.id的值，修改成相应的数字</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="添加环境变量"><a href="#添加环境变量" class="headerlink" title="添加环境变量"></a>添加环境变量</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#切换成root用户执行，修改profile文件</span><br><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line">#Kafka</span><br><span class="line">export KAFKA_HOME=/export/servers/kafka</span><br><span class="line">export PATH=$PATH:$KAFKA_HOME/bin</span><br><span class="line"></span><br><span class="line">#使配置生效</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<h2 id="kafka命令"><a href="#kafka命令" class="headerlink" title="kafka命令"></a>kafka命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#依次在各节点上启动kafka</span><br><span class="line">kafka-server-start.sh /export/servers/kafka/config/server.properties &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">#停止kafka</span><br><span class="line">kafka-server-stop.sh</span><br><span class="line"></span><br><span class="line">#查看当前服务器中的所有topic</span><br><span class="line">kafka-topics.sh --list --zookeeper bigdata01:2181</span><br><span class="line"></span><br><span class="line">#创建topic</span><br><span class="line">kafka-topics.sh --create --zookeeper bigdata01:2181 --replication-factor 3 --partitions 3 --topic test</span><br><span class="line"></span><br><span class="line">#删除topic</span><br><span class="line">kafka-topics.sh --delete --zookeeper bigdata01:2181 --topic test</span><br><span class="line">需要server.properties中设置delete.topic.enable=true否则只是标记删除或者直接重启。</span><br><span class="line"></span><br><span class="line">#通过shell命令发送消息</span><br><span class="line">kafka-console-producer.sh --broker-list bigdata01:9092 --topic test</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#通过shell消费消息</span><br><span class="line">kafka-console-consumer.sh --zookeeper bigdata01:2181 --from-beginning --topic test</span><br><span class="line"></span><br><span class="line">#查看消费位置</span><br><span class="line">kafka-run-class.sh kafka.tools.ConsumerOffsetChecker --zookeeper bigdata01:2181 --group testGroup</span><br><span class="line"></span><br><span class="line">#查看某个Topic的详情</span><br><span class="line">kafka-topics.sh --topic test --describe --zookeeper bigdata01:2181</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2088/01/01/layui-table-行选中checkbox勾选-行变色/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2088/01/01/layui-table-行选中checkbox勾选-行变色/" itemprop="url">layui-table-行选中checkbox勾选-行变色</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2088-01-01T08:00:02+08:00">
                2088-01-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/前端/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/2088/01/01/layui-table-行选中checkbox勾选-行变色/layui-table-行选中checkbox勾选-行变色.png" alt="layui-table-行选中checkbox勾选-行变色" title="layui-table-行选中checkbox勾选-行变色"></p>
<h3 id="完整代码实现"><a href="#完整代码实现" class="headerlink" title="完整代码实现"></a>完整代码实现</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">layui.use([..., <span class="string">'table'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> table = layui.table;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    table.render(&#123;</span><br><span class="line">         ...</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//监听复选框事件，被选中的行高亮显示</span></span><br><span class="line">    table.on(<span class="string">'checkbox(metadataTableFilter)'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (obj.checked == <span class="literal">true</span> &amp;&amp; obj.type == <span class="string">'all'</span>) &#123;</span><br><span class="line">            <span class="comment">//点击全选</span></span><br><span class="line">            $(<span class="string">'.layui-table-body table.layui-table tbody tr'</span>).addClass(<span class="string">'layui-table-click'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj.checked == <span class="literal">false</span> &amp;&amp; obj.type == <span class="string">'all'</span>) &#123;</span><br><span class="line">            <span class="comment">//点击全不选</span></span><br><span class="line">            $(<span class="string">'.layui-table-body table.layui-table tbody tr'</span>).removeClass(<span class="string">'layui-table-click'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj.checked == <span class="literal">true</span> &amp;&amp; obj.type == <span class="string">'one'</span>) &#123;</span><br><span class="line">            <span class="comment">//点击单行</span></span><br><span class="line">            <span class="keyword">if</span> (obj.checked == <span class="literal">true</span>) &#123;</span><br><span class="line">                obj.tr.addClass(<span class="string">'layui-table-click'</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                obj.tr.removeClass(<span class="string">'layui-table-click'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj.checked == <span class="literal">false</span> &amp;&amp; obj.type == <span class="string">'one'</span>) &#123;</span><br><span class="line">            <span class="comment">//点击全选之后点击单行</span></span><br><span class="line">            <span class="keyword">if</span> (obj.tr.hasClass(<span class="string">'layui-table-click'</span>)) &#123;</span><br><span class="line">                obj.tr.removeClass(<span class="string">'layui-table-click'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">//单击table行，勾选checkbox事件</span></span><br><span class="line">$(<span class="built_in">document</span>).on(<span class="string">"click"</span>, <span class="string">".layui-table-body table.layui-table tbody tr"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> index = $(<span class="keyword">this</span>).attr(<span class="string">'data-index'</span>);</span><br><span class="line">    <span class="keyword">var</span> tableBox = $(<span class="keyword">this</span>).parents(<span class="string">'.layui-table-box'</span>);</span><br><span class="line">    <span class="comment">//存在固定列</span></span><br><span class="line">    <span class="keyword">var</span> tableDiv;</span><br><span class="line">    <span class="keyword">if</span> (tableBox.find(<span class="string">".layui-table-fixed.layui-table-fixed-l"</span>).length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        tableDiv = tableBox.find(<span class="string">".layui-table-fixed.layui-table-fixed-l"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        tableDiv = tableBox.find(<span class="string">".layui-table-body.layui-table-main"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> checkLength = tableDiv.find(<span class="string">"tr[data-index="</span> + index + <span class="string">"]"</span>).find(</span><br><span class="line">        <span class="string">"td div.layui-form-checked"</span>).length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> checkCell = tableDiv.find(<span class="string">"tr[data-index="</span> + index + <span class="string">"]"</span>).find(</span><br><span class="line">        <span class="string">"td div.laytable-cell-checkbox div.layui-form-checkbox I"</span>);</span><br><span class="line">    <span class="keyword">if</span> (checkCell.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        checkCell.click();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$(<span class="built_in">document</span>).on(<span class="string">"click"</span>, <span class="string">"td div.laytable-cell-checkbox div.layui-form-checkbox"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    e.stopPropagation();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2088/01/01/jQuery-Validate-layer表单校验/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2088/01/01/jQuery-Validate-layer表单校验/" itemprop="url">jQuery-Validate-layer表单校验</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2088-01-01T08:00:01+08:00">
                2088-01-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/前端/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong><em>用jQuery Validate layer插件实现好看的表单校验</em></strong></p>
<p><img src="/2088/01/01/jQuery-Validate-layer表单校验/jQuery-Validate-layer表单校验效果.png" alt="jQuery-Validate-layer表单校验效果" title="jQuery-Validate-layer表单校验效果"></p>
<h3 id="完整代码实现"><a href="#完整代码实现" class="headerlink" title="完整代码实现"></a>完整代码实现</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">	&lt;head&gt;</span><br><span class="line">	    &lt;title&gt;valdate&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp">		&lt;meta charset="UTF-8"&gt;</span></span><br><span class="line"><span class="regexp">		&lt;link rel="stylesheet" type="text/</span>css<span class="string">" href="</span>http:<span class="comment">//layui.hcwl520.com.cn/layui-v2.4.5/css/layui.css?v=201811010202"/&gt;</span></span><br><span class="line">		</span><br><span class="line">	&lt;<span class="regexp">/head&gt;</span></span><br><span class="line"><span class="regexp">	</span></span><br><span class="line"><span class="regexp">	&lt;body style="padding-top: 20px"&gt;</span></span><br><span class="line"><span class="regexp">	&lt;form class="layui-form" id="signupForm" action=""&gt;</span></span><br><span class="line"><span class="regexp">		&lt;div class="layui-form-item"&gt;</span></span><br><span class="line"><span class="regexp">			&lt;label class="layui-form-label"&gt;名字&lt;/</span>label&gt;</span><br><span class="line">			&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"layui-input-inline"</span>&gt;</span><br><span class="line">				&lt;input type=<span class="string">"text"</span> id=<span class="string">"firstname"</span> name=<span class="string">"firstname"</span> autocomplete=<span class="string">"off"</span> placeholder=<span class="string">"请输入名字"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"layui-input"</span>&gt;</span><br><span class="line">			&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">		&lt;/</span>div&gt;</span><br><span class="line">		&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"layui-form-item"</span>&gt;</span><br><span class="line">			&lt;label <span class="class"><span class="keyword">class</span></span>=<span class="string">"layui-form-label"</span>&gt;姓氏&lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">			&lt;div class="layui-input-inline"&gt;</span></span><br><span class="line"><span class="regexp">				&lt;input type="text" id="lastname" name="lastname" autocomplete="off" placeholder="请输入姓氏" class="layui-input"&gt;</span></span><br><span class="line"><span class="regexp">			&lt;/</span>div&gt;</span><br><span class="line">		&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">		&lt;div class="layui-form-item"&gt;</span></span><br><span class="line"><span class="regexp">			&lt;label class="layui-form-label"&gt;用户名&lt;/</span>label&gt;</span><br><span class="line">			&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"layui-input-inline"</span>&gt;</span><br><span class="line">				&lt;input type=<span class="string">"text"</span> id=<span class="string">"username"</span> name=<span class="string">"username"</span> autocomplete=<span class="string">"off"</span> placeholder=<span class="string">"请输入用户名"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"layui-input"</span>&gt;</span><br><span class="line">			&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">		&lt;/</span>div&gt;</span><br><span class="line">		&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"layui-form-item"</span>&gt;</span><br><span class="line">			&lt;label <span class="class"><span class="keyword">class</span></span>=<span class="string">"layui-form-label"</span>&gt;密码&lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">			&lt;div class="layui-input-inline"&gt;</span></span><br><span class="line"><span class="regexp">				&lt;input type="password" id="password" name="password" autocomplete="off" placeholder="请输入密码" class="layui-input"&gt;</span></span><br><span class="line"><span class="regexp">			&lt;/</span>div&gt;</span><br><span class="line">		&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">		&lt;div class="layui-form-item"&gt;</span></span><br><span class="line"><span class="regexp">			&lt;label class="layui-form-label"&gt;验证密码&lt;/</span>label&gt;</span><br><span class="line">			&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"layui-input-inline"</span>&gt;</span><br><span class="line">				&lt;input type=<span class="string">"password"</span> id=<span class="string">"confirm_password"</span> name=<span class="string">"confirm_password"</span> autocomplete=<span class="string">"off"</span> placeholder=<span class="string">"请输入验证密码"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"layui-input"</span>&gt;</span><br><span class="line">			&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">		&lt;/</span>div&gt;</span><br><span class="line">		&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"layui-form-item"</span>&gt;</span><br><span class="line">			&lt;label <span class="class"><span class="keyword">class</span></span>=<span class="string">"layui-form-label"</span>&gt;Email&lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">			&lt;div class="layui-input-inline"&gt;</span></span><br><span class="line"><span class="regexp">				&lt;input type="text" id="email" name="email" autocomplete="off" placeholder="请输入Email" class="layui-input"&gt;</span></span><br><span class="line"><span class="regexp">			&lt;/</span>div&gt;</span><br><span class="line">		&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">		&lt;div class="layui-form-item"&gt;</span></span><br><span class="line"><span class="regexp">			&lt;label class="layui-form-label"&gt;&lt;/</span>label&gt;</span><br><span class="line">			&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"layui-input-inline"</span>&gt;</span><br><span class="line">				&lt;button <span class="class"><span class="keyword">class</span></span>=<span class="string">"layui-btn"</span> lay-submit=<span class="string">""</span> lay-filter=<span class="string">"demo1"</span>&gt;立即提交&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">				&lt;button type="reset" class="layui-btn layui-btn-primary"&gt;重置&lt;/</span>button&gt;</span><br><span class="line">			&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">		&lt;/</span>div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;<span class="regexp">/form&gt;</span></span><br><span class="line"><span class="regexp">	</span></span><br><span class="line"><span class="regexp">	&lt;script src="https:/</span><span class="regexp">/cdn.bootcss.com/</span>jquery/<span class="number">3.3</span><span class="number">.1</span>/jquery.min.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">	&lt;script src="</span>https:<span class="comment">//cdn.bootcss.com/jquery-validate/1.19.0/jquery.validate.min.js"&gt;&lt;/script&gt;</span></span><br><span class="line">	&lt;script src=<span class="string">"https://cdn.bootcss.com/jquery-validate/1.19.0/localization/messages_zh.min.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">	&lt;script src=<span class="string">"http://layui.hcwl520.com.cn/layui-v2.4.5/layui.js?v=201811010202"</span>&gt;&lt;/script&gt;</span><br><span class="line">	&lt;style&gt;</span><br><span class="line">	.layui-form-label &#123;</span><br><span class="line">		width: <span class="number">150</span>px;</span><br><span class="line">	&#125;</span><br><span class="line">	.layui-input &#123;</span><br><span class="line">		width: <span class="number">200</span>px;</span><br><span class="line">	&#125;</span><br><span class="line">	.layui-form-checkbox span &#123;</span><br><span class="line">		height: <span class="number">38</span>px;</span><br><span class="line">		vertical-align: middle;</span><br><span class="line">	&#125;</span><br><span class="line">	.error &#123;</span><br><span class="line">		color: blue;</span><br><span class="line">	&#125;</span><br><span class="line">    &lt;<span class="regexp">/style&gt;</span></span><br><span class="line"><span class="regexp">	&lt;script&gt;</span></span><br><span class="line"><span class="regexp">	    layui.use(['layer', 'form'], function () &#123;</span></span><br><span class="line"><span class="regexp">			var layer = layui.layer,</span></span><br><span class="line"><span class="regexp">				form = layui.form;</span></span><br><span class="line"><span class="regexp">		&#125;);</span></span><br><span class="line"><span class="regexp">	</span></span><br><span class="line"><span class="regexp">        $.validator.setDefaults(&#123;</span></span><br><span class="line"><span class="regexp">            submitHandler: function () &#123;</span></span><br><span class="line"><span class="regexp">                layer.alert("提交事件!");</span></span><br><span class="line"><span class="regexp">            &#125;</span></span><br><span class="line"><span class="regexp">        &#125;);</span></span><br><span class="line"><span class="regexp">		</span></span><br><span class="line"><span class="regexp">        $(function()&#123;</span></span><br><span class="line"><span class="regexp">            /</span><span class="regexp">/ 在键盘按下并释放及提交后验证提交表单</span></span><br><span class="line"><span class="regexp">            $("#signupForm").validate(&#123;</span></span><br><span class="line"><span class="regexp">				onfocusin: function (element) &#123;</span></span><br><span class="line"><span class="regexp">					$(element).valid();</span></span><br><span class="line"><span class="regexp">				&#125;,</span></span><br><span class="line"><span class="regexp">				onfocusout: function (element) &#123;</span></span><br><span class="line"><span class="regexp">					$(element).valid();</span></span><br><span class="line"><span class="regexp">				&#125;,</span></span><br><span class="line"><span class="regexp">				onclick: function (element) &#123;</span></span><br><span class="line"><span class="regexp">					$(element).valid();</span></span><br><span class="line"><span class="regexp">				&#125;,</span></span><br><span class="line"><span class="regexp">				/</span>*</span><br><span class="line">				onkeyup: <span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span><br><span class="line">					$(element).valid();</span><br><span class="line">				&#125;,</span><br><span class="line">				*<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                rules: &#123;</span></span><br><span class="line"><span class="regexp">                    firstname: "required",</span></span><br><span class="line"><span class="regexp">                    lastname: "required",</span></span><br><span class="line"><span class="regexp">                    username: &#123;</span></span><br><span class="line"><span class="regexp">                        required: true,</span></span><br><span class="line"><span class="regexp">                        minlength: 2</span></span><br><span class="line"><span class="regexp">                    &#125;,</span></span><br><span class="line"><span class="regexp">                    password: &#123;</span></span><br><span class="line"><span class="regexp">                        required: true,</span></span><br><span class="line"><span class="regexp">                        minlength: 5</span></span><br><span class="line"><span class="regexp">                    &#125;,</span></span><br><span class="line"><span class="regexp">                    confirm_password: &#123;</span></span><br><span class="line"><span class="regexp">                        required: true,</span></span><br><span class="line"><span class="regexp">                        minlength: 5,</span></span><br><span class="line"><span class="regexp">                        equalTo: "#password"</span></span><br><span class="line"><span class="regexp">                    &#125;,</span></span><br><span class="line"><span class="regexp">                    email: &#123;</span></span><br><span class="line"><span class="regexp">                        required: true,</span></span><br><span class="line"><span class="regexp">                        email: true</span></span><br><span class="line"><span class="regexp">                    &#125;</span></span><br><span class="line"><span class="regexp">                &#125;,</span></span><br><span class="line"><span class="regexp">                messages: &#123;</span></span><br><span class="line"><span class="regexp">                    firstname: "请输入您的名字",</span></span><br><span class="line"><span class="regexp">                    lastname: "请输入您的姓氏",</span></span><br><span class="line"><span class="regexp">                    username: &#123;</span></span><br><span class="line"><span class="regexp">                        required: "请输入用户名",</span></span><br><span class="line"><span class="regexp">                        minlength: "用户名不能少于两个字母"</span></span><br><span class="line"><span class="regexp">                    &#125;,</span></span><br><span class="line"><span class="regexp">                    password: &#123;</span></span><br><span class="line"><span class="regexp">                        required: "请输入密码",</span></span><br><span class="line"><span class="regexp">                        minlength: "密码长度不能小于 5 个字母"</span></span><br><span class="line"><span class="regexp">                    &#125;,</span></span><br><span class="line"><span class="regexp">                    confirm_password: &#123;</span></span><br><span class="line"><span class="regexp">                        required: "请输入密码",</span></span><br><span class="line"><span class="regexp">                        minlength: "密码长度不能小于 5 个字母",</span></span><br><span class="line"><span class="regexp">                        equalTo: "两次密码输入不一致"</span></span><br><span class="line"><span class="regexp">                    &#125;,</span></span><br><span class="line"><span class="regexp">                    email: "请输入一个正确的邮箱"</span></span><br><span class="line"><span class="regexp">                &#125;,</span></span><br><span class="line"><span class="regexp">                /</span><span class="regexp">/重写showErrors</span></span><br><span class="line"><span class="regexp">                showErrors: function (errorMap, errorList) &#123;</span></span><br><span class="line"><span class="regexp">					$.each(errorList, function (i, v) &#123;</span></span><br><span class="line"><span class="regexp">						/</span><span class="regexp">/layer显示</span></span><br><span class="line"><span class="regexp">						layer.tips(v.message, v.element, &#123;tips: [2, '#ee1212'], time: 1500&#125;);</span></span><br><span class="line"><span class="regexp">						return false;</span></span><br><span class="line"><span class="regexp">					&#125;);</span></span><br><span class="line"><span class="regexp">                &#125;,</span></span><br><span class="line"><span class="regexp">                /</span>* 失去焦点时不验证 *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                onfocusout: false</span></span><br><span class="line"><span class="regexp">            &#125;);</span></span><br><span class="line"><span class="regexp">        &#125;);</span></span><br><span class="line"><span class="regexp">    &lt;/</span>script&gt;</span><br><span class="line"></span><br><span class="line">	&lt;<span class="regexp">/body&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>html&gt;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2066/01/01/mybatis问题解决集合/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2066/01/01/mybatis问题解决集合/" itemprop="url">mybatis问题解决集合</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2066-01-01T00:00:01+08:00">
                2066-01-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">mybatis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="mybatis-foreach使用"><a href="#mybatis-foreach使用" class="headerlink" title="mybatis-foreach使用"></a><strong>mybatis-foreach使用</strong></h2><p><strong>前言</strong>：</p>
<blockquote>
<p>后台传给mapper的字符串：<code>&quot;b, c&quot;</code>,<br>mybatis需生成<code>select * from table where ids in (&#39;b&#39;, &#39;e&#39;)</code>语句，来执行查询。</p>
</blockquote>
<p><strong>解决方法</strong>：</p>
<blockquote>
<p>mybatis只需使用foreach语句，即可实现功能。</p>
</blockquote>
<p><strong>mybatis-xml配置</strong>：</p>
<blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getSimilarity"</span> <span class="attr">parameterType</span>=<span class="string">"java.lang.String"</span> <span class="attr">resultType</span>=<span class="string">"java.util.HashMap"</span>&gt;</span></span><br><span class="line">    select * from table</span><br><span class="line">	where ids in </span><br><span class="line">	<span class="tag">&lt;<span class="name">foreach</span> <span class="attr">item</span>=<span class="string">"item"</span> <span class="attr">index</span>=<span class="string">"index"</span> <span class="attr">collection</span>=<span class="string">"ids.split(’,’)"</span>  <span class="attr">open</span>=<span class="string">"("</span> <span class="attr">separator</span>=<span class="string">","</span> <span class="attr">close</span>=<span class="string">")"</span>&gt;</span></span><br><span class="line">		#&#123;item&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>控制台打印</strong>：</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Preparing: select * from table where ids in ( ? , ?  ) </span><br><span class="line">Parameters: b(String), e(String)</span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li></li>
<li></li>
<li></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/08/安装hexo并部署到github-page上/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/08/安装hexo并部署到github-page上/" itemprop="url">安装hexo并部署到github-page上</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-08T15:43:40+08:00">
                2019-05-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/28/Spring读取properties文件内容/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/28/Spring读取properties文件内容/" itemprop="url">Spring读取properties文件内容</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-28T09:04:50+08:00">
                2019-04-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/28/76-83-热点数据缓存问题及解决方案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/28/76-83-热点数据缓存问题及解决方案/" itemprop="url">76-83热点缓存问题及解决方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-28T16:42:21+08:00">
                2019-01-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="76-瞬间的缓存热点数据问题"><a href="#76-瞬间的缓存热点数据问题" class="headerlink" title="76-瞬间的缓存热点数据问题"></a>76-瞬间的缓存热点数据问题</h2><p>热数据 -&gt; 热数据的统计 -&gt; redis中缓存的预热 -&gt; 避免新系统刚上线，或者是redis崩溃数据丢失后重启，redis中没有数据，redis冷启动 -&gt; 大量流量直接到数据库</p>
<p>redis启动前，必须确保其中是有部分热数据的缓存的</p>
<p><img src="/2019/01/28/76-83-热点数据缓存问题及解决方案/热点缓存导致系统崩溃的问题.png" alt="热点缓存导致系统崩溃的问题" title="热点缓存导致系统崩溃的问题"></p>
<h2 id="77-基于nginx-lua-storm的热点缓存的流量分发策略自动降级解决方案"><a href="#77-基于nginx-lua-storm的热点缓存的流量分发策略自动降级解决方案" class="headerlink" title="77-基于nginx+lua+storm的热点缓存的流量分发策略自动降级解决方案"></a>77-基于nginx+lua+storm的热点缓存的流量分发策略自动降级解决方案</h2><ol>
<li><p>在storm中，实时地计算出瞬间出现的热点数据</p>
<blockquote>
<p>有很多种算法，介绍一种比较简单的算法<br>某个storm task，上面算出了1万个商品的访问次数，LRUMap<br>计算频率高一些，每隔5秒去遍历一次LRUMap，将其中的访问次数进行排序，统计出排在95%的商品访问次数的平均值<br>比如：<br>1000<br>999<br>888<br>777<br>666<br>50<br>60<br>80<br>100<br>120</p>
<p>比如说，排在95%的商品，访问次数的平均值是100</p>
<p>然后，从最前面开始，往后遍历，去找有没有瞬间出现的热点数据</p>
<p>1000，是95%的平均值（100）的10倍，这个时候要设定一个阈值，比如说超出95%平均值的n倍，5倍</p>
<p>我们就认为是瞬间出现的热点数据，判断其可能在短时间内继续扩大的访问量，甚至达到平均值几十倍，或者几百倍</p>
<p>当遍历，发现说第一个商品的访问次数，小于平均值的5倍，就安全了，就break掉这个循环</p>
<p><strong><em>热点数据</em></strong>，<strong><em>热数据</em></strong>，不是一个概念</p>
</blockquote>
<p>有100个商品，前10个商品比较热，访问量在500左右，其他普通商品，访问量都在200左右，就说前10个商品是<strong><em>热数据</em></strong></p>
<blockquote>
</blockquote>
<p>预热的时候，将这些热数据加载到缓存中就可以了。</p>
<blockquote>
</blockquote>
<p><strong><em>热点数据</em></strong>：某个商品的访问量，瞬间超出了普通商品的10倍，或者100倍，1000倍。</p>
</li>
<li><p>storm直接发送http请求到nginx上，nginx上用lua脚本去处理这个请求</p>
<p> storm会将热点数据对应的productId，发送到流量分发nginx上面去，放在本地缓存中<br> storm会将热点数据对应的完整的缓存数据，发送到所有的应用nginx服务器上去，直接放在本地缓存中</p>
</li>
<li><p>流量分发nginx的分发策略降级</p>
<p> 流量分发nginx，加一个逻辑，就是每次访问一个商品详情页的时候，如果发现它是个热点，那么立即做流量分发策略的<strong><em>降级</em></strong></p>
<p> hash策略，同一个productId的访问都对一个同一台应用nginx服务器</p>
<p> 降级成对这个热点商品，流量分发采取<strong><em>随机负载均衡</em></strong>发送到所有的后端应用nginx服务器上去</p>
<p> 瞬间将热点缓存数据的访问，从hash分发到一台nginx，变成了，负载均衡发送到多台nginx上去</p>
<p> 避免说大量的流量全部集中到一台机器，50万的访问量到一台nginx，5台应用nginx，每台就可以承载10万的访问量</p>
</li>
<li><p>storm还需要保存下来上次识别出来的热点list</p>
<p> 下次去识别的时候，这次的热点list跟上次的热点list做一下diff，有的商品已经不是热点数据了</p>
<p> 热点数据的取消的逻辑：发送http请求到流量分发nginx上去，取消掉对应的热点数据，从nginx本地缓存中删除</p>
</li>
</ol>
<p><img src="/2019/01/28/76-83-热点数据缓存问题及解决方案/热点缓存的解决方案.png" alt="热点缓存的解决方案" title="热点缓存的解决方案"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/16/68-75-缓存冷启动及缓存预热解决方案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/16/68-75-缓存冷启动及缓存预热解决方案/" itemprop="url">68-90缓存冷启动及缓存预热解决方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-16T16:42:21+08:00">
                2019-01-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="缓存冷启动的问题"><a href="#缓存冷启动的问题" class="headerlink" title="缓存冷启动的问题"></a>缓存冷启动的问题</h2><ol>
<li><p>新系统第一次上线，此时在缓存里可能是没有数据的</p>
</li>
<li><p>系统在线上稳定运行着，但是突然间重要的redis缓存全盘崩溃了，而且不幸的是，数据全都无法找回来</p>
</li>
</ol>
<p><img src="/2019/01/16/68-75-缓存冷启动及缓存预热解决方案/缓存冷启动问题.png" alt="缓存冷启动问题" title="缓存冷启动问题"></p>
<h2 id="缓存预热"><a href="#缓存预热" class="headerlink" title="缓存预热"></a>缓存预热</h2><p><strong><em>缓存冷启动，redis启动后，一点数据都没有，直接就对外提供服务了，mysql就裸奔</em></strong></p>
<h3 id="解决方案："><a href="#解决方案：" class="headerlink" title="解决方案："></a>解决方案：</h3><ol>
<li>提前给redis中灌入部分数据，再提供服务</li>
<li>肯定不可能将所有数据都写入redis，因为数据量太大了，第一耗费的时间太长了，第二根本redis容纳不下所有的数据</li>
<li>需要根据当天的具体访问情况，实时统计出访问频率较高的热数据</li>
<li>然后将访问频率较高的热数据写入redis中，肯定是热数据也比较多，我们也得多个服务并行读取数据去写，并行的分布式的缓存预热</li>
<li>然后将灌入了热数据的redis对外提供服务，这样就不至于冷启动，直接让数据库裸奔了</li>
</ol>
<hr>
<h3 id="代码实现思路："><a href="#代码实现思路：" class="headerlink" title="代码实现思路："></a>代码实现思路：</h3><ol>
<li><p>nginx+lua将访问流量上报到kafka中</p>
<blockquote>
<p>要统计出来当前最新的实时的热数据有哪些，我们就得将商品详情页访问的请求对应的流量、日志，实时上报到kafka中</p>
</blockquote>
</li>
<li><p>storm从kafka中消费数据，实时统计出每个商品的访问次数，访问次数基于LRU内存数据结构的存储方案</p>
<blockquote>
<p>优先使用内存中的一个LRUMap去存放，优点是性能高而且没有外部依赖<br>如果使用redis，要防止redis挂掉，导致数据丢失的情况。如果用mysql，扛不住高并发读写; 用hbase，hadoop生态系统，维护麻烦，太重了</p>
<p>只要统计出最近一段时间访问最频繁的商品，然后对它们进行访问计数，同时维护出一个前N个访问最多的商品list即可。</p>
<p>热数据：最近一段时间，比如最近1个小时，最近5分钟，1万个商品请求，统计出最近这段时间内每个商品的访问次数，排序，做出一个排名前N的list</p>
<p>计算好每个task大致要存放的商品访问次数的数量，计算出大小</p>
<p>然后构建一个LRUMap，apache commons collections有开源的实现，设定好map的最大大小，就会自动根据LRU算法去剔除多余的数据，保证内存使用限制</p>
<p>即使有部分数据被干掉了，然后下次来重新开始计数，也没关系，因为如果它被LRU算法干掉，那么它就不是热数据，说明最近一段时间都很少访问了</p>
</blockquote>
</li>
<li><p>每个storm task启动的时候，基于zookeeper分布式锁，将自己的id写入zookeeper同一个节点中</p>
</li>
<li><p>每个storm task负责完成自己这里的热数据的统计，每隔一段时间，就遍历一下这个map，然后维护一个前N个商品的list，更新这个list</p>
</li>
<li><p>写一个后台线程，每隔一段时间，比如1分钟，都将排名前N的热数据list，同步到zookeeper中去，存储到这个storm task对应的一个zNode中去</p>
</li>
<li><p>我们需要一个服务，比如说，代码可以跟缓存数据生产服务放一起，但是也可以放单独的服务</p>
<blockquote>
<p>服务可能部署了很多个实例</p>
<p>每次服务启动的时候，就会去拿到一个storm task的列表，然后根据taskId，一个一个的去尝试获取taskId对应的zNode的zookeeper分布式锁</p>
<p>如果能获取到分布式锁的话，那么就将那个storm task对应的热数据的list取出来<br>然后将数据从mysql中查询出来，写入缓存中，进行缓存的预热，多个服务实例，分布式的并行的去做，基于zk分布式锁做了协调了，分布式并行缓存的预热</p>
</blockquote>
</li>
</ol>
<hr>
<h3 id="基于nginx-lua完成商品详情页访问流量实时上报kafka的开发"><a href="#基于nginx-lua完成商品详情页访问流量实时上报kafka的开发" class="headerlink" title="基于nginx+lua完成商品详情页访问流量实时上报kafka的开发"></a>基于nginx+lua完成商品详情页访问流量实时上报kafka的开发</h3><p><strong><em>不在分发服务器做，在实际处理请求的机器上做，bigdata01，bigdata02</em></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">#使用root用户安装</span><br><span class="line">yum install -y unzip</span><br><span class="line"></span><br><span class="line">#以下命令使用bigdata用户</span><br><span class="line"></span><br><span class="line">#需要在nginx.conf中，http部分，加入resolver 8.8.8.8;</span><br><span class="line">vi /export/servers/nginx/conf/nginx.conf</span><br><span class="line">...</span><br><span class="line">http &#123;</span><br><span class="line">    resolver 8.8.8.8;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">#需要在kafka中加入 advertised.host.name = 192.168.33.6* ，重启三个kafka进程</span><br><span class="line">vi /export/servers/kafka/config/server.properties</span><br><span class="line">...</span><br><span class="line">#每台机器根据本机ip修改</span><br><span class="line">advertised.host.name = 192.168.33.61</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cd /home/bigdata/software</span><br><span class="line">wget https://github.com/doujiang24/lua-resty-kafka/archive/master.zip</span><br><span class="line">chmod 777 /home/bigdata/software/master.zip</span><br><span class="line">unzip /home/bigdata/software/master.zip</span><br><span class="line">cp -rf /home/bigdata/software/lua-resty-kafka-master/lib/resty /home/bigdata/ngnix-test/lualib</span><br><span class="line"></span><br><span class="line">#编辑lua脚本</span><br><span class="line">vi /home/bigdata/ngnix-test/lua/product.lua</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">#注意不要重复引入相关lib</span><br><span class="line">local cjson = require(&quot;cjson&quot;)</span><br><span class="line">local producer = require(&quot;resty.kafka.producer&quot;)</span><br><span class="line"></span><br><span class="line">local broker_list = &#123;</span><br><span class="line">	&#123; host = &quot;192.168.33.61&quot;, port = 9092 &#125;,</span><br><span class="line">	&#123; host = &quot;192.168.33.62&quot;, port = 9092 &#125;,</span><br><span class="line">	&#123; host = &quot;192.168.33.63&quot;, port = 9092 &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-- 将需要的数据放入json数据中</span><br><span class="line">local log_json = &#123;&#125;</span><br><span class="line">log_json[&quot;request_module&quot;] = &quot;product_detail_info&quot;</span><br><span class="line">log_json[&quot;headers&quot;] = ngx.req.get_headers()</span><br><span class="line">log_json[&quot;uri_args&quot;] = ngx.req.get_uri_args()</span><br><span class="line">log_json[&quot;body&quot;] = ngx.req.read_body()</span><br><span class="line">log_json[&quot;http_version&quot;] = ngx.req.http_version()</span><br><span class="line">log_json[&quot;method&quot;] =ngx.req.get_method() </span><br><span class="line">log_json[&quot;raw_reader&quot;] = ngx.req.raw_header()</span><br><span class="line">log_json[&quot;body_data&quot;] = ngx.req.get_body_data()</span><br><span class="line"></span><br><span class="line">-- json转string</span><br><span class="line">local message = cjson.encode(log_json);</span><br><span class="line"></span><br><span class="line">local productId = ngx.req.get_uri_args()[&quot;productId&quot;]</span><br><span class="line"></span><br><span class="line">-- 构建kafka producer</span><br><span class="line">local async_producer = producer:new(broker_list, &#123; producer_type = &quot;async&quot; &#125;)</span><br><span class="line">-- 将数据发给kafka</span><br><span class="line">local ok, err = async_producer:send(&quot;access-log&quot;, productId, message)</span><br><span class="line"></span><br><span class="line">if not ok then</span><br><span class="line">	ngx.log(ngx.ERR, &quot;kafka send err:&quot;, err)</span><br><span class="line">	return</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#使用root启动nginx或重新加载nginx</span><br><span class="line">/export/servers/nginx/sbin/nginx</span><br><span class="line">/export/servers/nginx/sbin/nginx -s reload</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">两台机器上都这样做，才能统一上报流量到kafka</span><br><span class="line"></span><br><span class="line">#创建access-log topic</span><br><span class="line">kafka-topics.sh --zookeeper 192.168.33.61:2181,192.168.33.62:2181,192.168.33.63:2181 --topic access-log --replication-factor 1 --partitions 1 --create</span><br><span class="line"></span><br><span class="line">#使用kafka消费命令消费数据，查看数据产生情况</span><br><span class="line">kafka-console-consumer.sh --zookeeper 192.168.33.61:2181,192.168.33.62:2181,192.168.33.63:2181 --topic access-log --from-beginning</span><br></pre></td></tr></table></figure></p>
<p>#使用浏览器产生数据</p>
<p><a href="http://192.168.33.61/product?requestPath=product&amp;productId=11&amp;shopId=1" target="_blank" rel="noopener">http://192.168.33.61/product?requestPath=product&amp;productId=11&amp;shopId=1</a></p>
<p><strong>注意事项：</strong></p>
<ol>
<li><p>kafka进程挂了，可能是虚拟机的问题，杀掉进程，重新启动一下</p>
</li>
<li><p>需要启动eshop-cache缓存服务，因为nginx中的本地缓存可能不在了</p>
</li>
</ol>
<p><img src="/2019/01/16/68-75-缓存冷启动及缓存预热解决方案/热启动方案注意点-1.png" alt="热启动方案注意点-1" title="热启动方案注意点-1"></p>
<h2 id="基于storm-kafka完成商品访问次数实时统计拓扑的开发"><a href="#基于storm-kafka完成商品访问次数实时统计拓扑的开发" class="headerlink" title="基于storm-kafka完成商品访问次数实时统计拓扑的开发"></a>基于storm-kafka完成商品访问次数实时统计拓扑的开发</h2><blockquote>
<p>nignx将访问日志通过kafka发送给storm，storm消费kafka消息</p>
</blockquote>
<h2 id="基于storm完成LRUMap中topn热门商品列表的算法讲解与编写"><a href="#基于storm完成LRUMap中topn热门商品列表的算法讲解与编写" class="headerlink" title="基于storm完成LRUMap中topn热门商品列表的算法讲解与编写"></a>基于storm完成LRUMap中topn热门商品列表的算法讲解与编写</h2><blockquote>
<p>storm消费kafka消息，并统计结果，将结果放入LRUMap中，再写算法取TopN结果</p>
</blockquote>
<h2 id="基于storm-zookeeper完成热门商品列表的分段存储"><a href="#基于storm-zookeeper完成热门商品列表的分段存储" class="headerlink" title="基于storm-zookeeper完成热门商品列表的分段存储"></a>基于storm-zookeeper完成热门商品列表的分段存储</h2><ol>
<li><p>将storm自己运行的task的 taskId 写入一个 zookeeper node 中，形成 taskId 的列表</p>
<blockquote>
<p>/taskId-list,111,222,333</p>
</blockquote>
</li>
<li><p>然后每次都将自己的热门商品列表，写入自己的 taskId 对应的 zookeeper 节点 </p>
<blockquote>
<p>&lt;”/task-hot-product-list-taskId”, 热门商品列表&gt;</p>
</blockquote>
</li>
<li><p>然后这样的话，并行的预热程序才能从第一步中知道，有哪些 taskId</p>
</li>
<li><p>然后并行预热程序根据每个 taskId 去获取一个锁，然后再从对应的 zNode 中拿到热门商品列表</p>
</li>
</ol>
<h2 id="基于双重zookeeper分布式锁完成分布式并行缓存预热的代码开发"><a href="#基于双重zookeeper分布式锁完成分布式并行缓存预热的代码开发" class="headerlink" title="基于双重zookeeper分布式锁完成分布式并行缓存预热的代码开发"></a>基于双重zookeeper分布式锁完成分布式并行缓存预热的代码开发</h2><ol>
<li><p>服务启动的时候，进行缓存预热</p>
</li>
<li><p>从zk中读取 taskId 列表</p>
</li>
<li><p>依次遍历每个 taskId，尝试获取分布式锁，如果获取不到，快速报错，不要等待，因为说明已经有其他服务实例在预热了</p>
</li>
<li><p>直接尝试获取下一个 taskId 的分布式锁</p>
</li>
<li><p>即使获取到了分布式锁，也要检查一下这个 taskId 的预热状态，如果已经被预热过了，就不再预热了</p>
</li>
<li><p>执行预热操作，遍历 productId 列表，查询数据，然后写ehcache和redis</p>
</li>
<li><p>预热完成后，设置 taskId 对应的预热状态</p>
</li>
</ol>
<h2 id="将缓存预热解决方案的代码运行后观察效果以及调试和修复所有的bug"><a href="#将缓存预热解决方案的代码运行后观察效果以及调试和修复所有的bug" class="headerlink" title="将缓存预热解决方案的代码运行后观察效果以及调试和修复所有的bug"></a>将缓存预热解决方案的代码运行后观察效果以及调试和修复所有的bug</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/08/61-67-Storm教程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/08/61-67-Storm教程/" itemprop="url">61-67-Storm教程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-08T18:01:34+08:00">
                2019-01-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storm/" itemprop="url" rel="index">
                    <span itemprop="name">storm</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Storm到底是什么？"><a href="#Storm到底是什么？" class="headerlink" title="Storm到底是什么？"></a><strong><em>Storm到底是什么？</em></strong></h1><h2 id="mysql、hadoop与storm"><a href="#mysql、hadoop与storm" class="headerlink" title="mysql、hadoop与storm"></a>mysql、hadoop与storm</h2><blockquote>
<p>mysql：事务性系统，面临海量数据的尴尬<br>hadoop：离线批处理<br>storm：实时计算</p>
</blockquote>
<h2 id="我们能不能自己搞一套storm？"><a href="#我们能不能自己搞一套storm？" class="headerlink" title="我们能不能自己搞一套storm？"></a>我们能不能自己搞一套storm？</h2><ol>
<li>花费大量的时间在底层技术细节上：如何部署各种中间队列，节点间的通信，容错，资源调配，计算节点的迁移和部署，等等</li>
<li>花费大量的时间在系统的高可用上问题上：如何保证各种节点能够高可用稳定运行</li>
<li>花费大量的时间在系统扩容上：吞吐量需要扩容的时候，你需要花费大量的时间去增加节点，修改配置，测试，等等</li>
</ol>
<h2 id="storm的特点是什么？"><a href="#storm的特点是什么？" class="headerlink" title="storm的特点是什么？"></a>storm的特点是什么？</h2><ol>
<li><p>支撑各种实时类的项目场景</p>
<blockquote>
<p>实时处理消息以及更新数据库，基于最基础的实时计算语义和API（实时数据处理领域）；对实时的数据流持续的进行查询或计算，<br>同时将最新的计算结果持续的推送给客户端展示，同样基于最基础的实时计算语义和API（实时数据分析领域）；<br>对耗时的查询进行并行化，基于DRPC，即分布式RPC调用，单表30天数据，并行化，每个进程查询一天数据，最后组装结果</p>
</blockquote>
</li>
<li><p>高度的可伸缩性</p>
<blockquote>
<p>如果要扩容，直接加机器，调整storm计算作业的并行度就可以了，storm会自动部署更多的进程和线程到其他的机器上去，无缝快速扩容<br>扩容起来，超方便</p>
</blockquote>
</li>
<li><p>数据不丢失的保证</p>
<blockquote>
<p>storm的消息可靠机制开启后，可以保证一条数据都不丢<br>数据不丢失，也不重复计算</p>
</blockquote>
</li>
<li><p>超强的健壮性</p>
<blockquote>
<p>从历史经验来看，storm比hadoop、spark等大数据类系统，健壮的多的多，因为元数据全部放zookeeper，不在内存中，随便挂都不要紧<br>特别的健壮，稳定性和可用性很高</p>
</blockquote>
</li>
<li><p>使用的便捷性</p>
<blockquote>
<p>核心语义非常的简单，开发起来效率很高<br>用起来很简单，开发API还是很简单的</p>
</blockquote>
</li>
</ol>
<p><img src="/2019/01/08/61-67-Storm教程/mysql-hadoop与storm的关系.png" alt="mysql-hadoop与storm的关系" title="mysql-hadoop与storm的关系"></p>
<hr>
<h1 id="Storm集群架构与核心概念"><a href="#Storm集群架构与核心概念" class="headerlink" title="Storm集群架构与核心概念"></a>Storm集群架构与核心概念</h1><h2 id="Storm的集群架构"><a href="#Storm的集群架构" class="headerlink" title="Storm的集群架构"></a>Storm的集群架构</h2><p><strong><em>Nimbus，Supervisor，ZooKeeper，Worker，Executor，Task</em></strong><br><img src="/2019/01/08/61-67-Storm教程/storm集群架构.png" alt="storm集群架构" title="storm集群架构"></p>
<h2 id="Storm的核心概念"><a href="#Storm的核心概念" class="headerlink" title="Storm的核心概念"></a>Storm的核心概念</h2><p><strong><em>Topology，Spout，Bolt，Tuple，Stream</em></strong></p>
<blockquote>
<ul>
<li>拓扑(Topology)：务虚的一个概念</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>Spout：数据源的一个代码组件，就是我们可以实现一个spout接口，写一个java类，在这个spout代码中，我们可以自己尝试去数据源获取数据，比如说从kafka中消费数据</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>bolt：一个业务处理的代码组件，spout会将数据传送给bolt，各种bolt还可以串联成一个计算链条，java类实现了一个bolt接口</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>一堆spout+bolt，就会组成一个topology，就是一个拓扑，实时计算作业，spout+bolt，一个拓扑涵盖数据源获取/生产+数据处理的所有的代码逻辑，topology</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>tuple：就是一条数据，每条数据都会被封装在tuple中，在多个spout和bolt之间传递</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>stream：就是一个流，务虚的一个概念，抽象的概念，源源不断过来的tuple，就组成了一条数据流<br><img src="/2019/01/08/61-67-Storm教程/storm核心概念.png" alt="storm核心概念" title="storm核心概念"></li>
</ul>
</blockquote>
<h2 id="Storm的并行度和流分组"><a href="#Storm的并行度和流分组" class="headerlink" title="Storm的并行度和流分组"></a>Storm的并行度和流分组</h2><p><strong><em>并行度和流分组</em></strong></p>
<ul>
<li><p>并行度：Worker-&gt;Executor-&gt;Task，没错，是Task</p>
</li>
<li><p>流分组：Task与Task之间的数据流向关系</p>
</li>
</ul>
<blockquote>
<ul>
<li>Shuffle Grouping：随机发射，负载均衡</li>
<li>Fields Grouping：根据某一个，或者某些个fields，进行分组，那一个或者多个fields如果值完全相同的话，那么这些tuple，就会发送给下游bolt的其中固定的一个task<br>你发射的每条数据是一个tuple，每个tuple中有多个field作为字段<br>比如tuple，3个字段，name，age，salary<br>{“name”: “tom”, “age”: 25, “salary”: 10000} -&gt; tuple -&gt; 3个field，name，age，salary</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>All Grouping：全分组，发射给下游的每个task</li>
<li>Global Grouping：全局id最小的</li>
<li>None Grouping 与 Shuffle Grouping相同</li>
<li>Direct Grouping：直接指定</li>
<li>Local or Shuffle Grouping：同一个executor中</li>
</ul>
</blockquote>
<p><img src="/2019/01/08/61-67-Storm教程/storm并行度和流分组.png" alt="storm并行度和流分组" title="storm并行度和流分组"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/28/57-分布式缓存重建并发冲突问题以及zookeeper分布式锁解决方案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/28/57-分布式缓存重建并发冲突问题以及zookeeper分布式锁解决方案/" itemprop="url">57-分布式缓存重建并发冲突问题以及zookeeper分布式锁解决方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-28T14:47:13+08:00">
                2018-12-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>如果缓存服务在本地的ehcache中都读取不到数据，这个时候就意味着，需要重新到源头的服务中去拉取数据，拉取到数据之后，赶紧先给nginx的请求返回，同时将数据写入ehcache和redis中。</p>
<h2 id="分布式重建缓存的并发冲突问题"><a href="#分布式重建缓存的并发冲突问题" class="headerlink" title="分布式重建缓存的并发冲突问题"></a><strong>分布式重建缓存的并发冲突问题</strong></h2><p><strong>重建缓存</strong>：</p>
<blockquote>
<p>数据在所有的缓存中都不存在了（LRU算法清理了），就需要重新查询数据写入缓存，重建缓存。</p>
</blockquote>
<p><strong>分布式的重建缓存</strong>：</p>
<blockquote>
<p>在不同的机器上，不同的服务实例中，去做上面的事情，就会出现多个机器分布式重建去读取相同的数据，然后写入缓存中。</p>
</blockquote>
<h2 id="分布式重建缓存的并发冲突问题-1"><a href="#分布式重建缓存的并发冲突问题-1" class="headerlink" title="分布式重建缓存的并发冲突问题"></a><strong>分布式重建缓存的并发冲突问题</strong></h2><ol>
<li><p>流量均匀分布到所有缓存服务实例上</p>
<blockquote>
<p>应用层nginx，是将请求流量均匀地打到各个缓存服务实例中的，可能咱们的eshop-cache那个服务，可能会部署多实例在不同的机器上</p>
</blockquote>
</li>
<li><p>应用层nginx的hash，固定商品id，走固定的缓存服务实例</p>
<blockquote>
<p>分发层的nginx的lua脚本，有应用层nginx的地址列表，对每个商品id做一个hash，然后对应用nginx数量取模。</p>
</blockquote>
<blockquote>
<p>将每个商品的请求固定分发到同一个应用层nginx上面去</p>
</blockquote>
<blockquote>
<p>在应用层nginx里，发现自己本地lua shared dict缓存中没有数据的时候，就采取一样的方式，对product id取模，然后将请求固定分发到同一个缓存服务实例中去</p>
</blockquote>
<blockquote>
<p>这样的话，就不会出现说多个缓存服务实例分布式的去更新那个缓存了</p>
</blockquote>
<blockquote>
<p><strong><em>留个作业，大家去做吧，这个东西，之前已经讲解过了，lua脚本几乎都是一模一样的，我们就不去做了，节省点时间</em></strong></p>
</blockquote>
</li>
<li><p>源信息服务发送的变更消息，需要按照商品id去分区，固定的商品变更走固定的kafka分区，也就是固定的一个缓存服务实例获取到</p>
<blockquote>
<p>缓存服务，是监听kafka topic的，一个缓存服务实例，作为一个kafka consumer，就消费topic中的一个partition</p>
</blockquote>
<blockquote>
<p>所以你有多个缓存服务实例的话，每个缓存服务实例就消费一个kafka partition</p>
</blockquote>
<blockquote>
<p>所以这里，一般来说，你的源头信息服务，在发送消息到kafka topic的时候，都需要按照product id去分区</p>
</blockquote>
<blockquote>
<p>也就时说，同一个product id变更的消息一定是到同一个kafka partition中去的，也就是说同一个product id的变更消息，一定是同一个缓存服务实例消费到的</p>
</blockquote>
<blockquote>
<p><strong><em>我们也不去做了，其实很简单，kafka producer api，里面send message的时候，多加一个参数就可以了，product id传递进去，就可以了</em></strong></p>
</blockquote>
</li>
<li><p>问题是，自己写的简易的hash分发，与kafka的分区，可能并不一致！！！</p>
<blockquote>
<p>我们自己写的简易的hash分发策略，是按照crc32去取hash值，然后再取模的</p>
</blockquote>
<blockquote>
<p>关键你又不知道你的kafka producer的hash策略是什么，很可能说跟我们的策略是不一样的</p>
</blockquote>
<blockquote>
<p>那就可能导致说，数据变更的消息所到的缓存服务实例，跟我们的应用层nginx分发到的那个缓存服务实例也许就不在一台机器上了</p>
</blockquote>
<blockquote>
<p>这样的话，在高并发，极端的情况下，可能就会出现冲突</p>
</blockquote>
</li>
<li><p>分布式的缓存重建并发冲突问题发生了。。。</p>
</li>
<li><p>基于zookeeper分布式锁的解决方案</p>
<blockquote>
<p>分布式锁，如果你有多个机器在访问同一个共享资源，那么这个时候，如果你需要加个锁，让多个分布式的机器在访问共享资源的时候串行起来</p>
</blockquote>
<blockquote>
<p>那么这个时候，那个锁，多个不同机器上的服务共享的锁，就是分布式锁</p>
</blockquote>
<blockquote>
<p>分布式锁当然有很多种不同的实现方案，redis分布式锁，zookeeper分布式锁</p>
</blockquote>
<blockquote>
<p>zk，做分布式协调这一块，还是很流行的，大数据应用里面，hadoop，storm，都是基于zk去做分布式协调</p>
</blockquote>
<blockquote>
<p><strong>zk分布式锁的解决并发冲突的方案</strong></p>
</blockquote>
<blockquote>
<blockquote>
<ol>
<li>变更缓存重建以及空缓存请求重建，更新redis之前，都需要先获取对应商品id的分布式锁</li>
<li>拿到分布式锁之后，需要根据时间版本去比较一下，如果自己的版本新于redis中的版本，那么就更新，否则就不更新</li>
<li>如果拿不到分布式锁，那么就等待，不断轮询等待，直到自己获取到分布式的锁</li>
</ol>
</blockquote>
</blockquote>
</li>
</ol>
<hr>
<p><img src="/2018/12/28/57-分布式缓存重建并发冲突问题以及zookeeper分布式锁解决方案/多个缓存服务实例分布式重建的并发冲突问题.png" alt="多个缓存服务实例分布式重建的并发冲突问题" title="多个缓存服务实例分布式重建的并发冲突问题"></p>
<p><img src="/2018/12/28/57-分布式缓存重建并发冲突问题以及zookeeper分布式锁解决方案/缓存更新和缓存重建在不同机器上的并发冲突问题.png" alt="缓存更新和缓存重建在不同机器上的并发冲突问题" title="缓存更新和缓存重建在不同机器上的并发冲突问题"></p>
<p><img src="/2018/12/28/57-分布式缓存重建并发冲突问题以及zookeeper分布式锁解决方案/基于zookeeper分布式锁的冲突解决方案.png" alt="基于zookeeper分布式锁的冲突解决方案" title="基于zookeeper分布式锁的冲突解决方案"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/27/54-基于nginx-lua-java完成多级缓存架构的核心业务逻辑/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/27/54-基于nginx-lua-java完成多级缓存架构的核心业务逻辑/" itemprop="url">54-基于nginx-lua-java完成多级缓存架构的核心业务逻辑</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-27T19:38:12+08:00">
                2018-12-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>分发层nginx，lua应用，会将商品id，商品店铺id，都转发到后端的应用nginx。</p>
<p>分发层ngnix配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">vi /home/bigdata/ngnix-test/ngnix-test.conf</span><br><span class="line"></span><br><span class="line">	location /product &#123;</span><br><span class="line">		default_type &apos;text/html&apos;;</span><br><span class="line">		content_by_lua_file /home/bigdata/ngnix-test/lua/distribute.lua;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">vi /home/bigdata/ngnix-test/lua/distribute.lua</span><br><span class="line"></span><br><span class="line">local uri_args = ngx.req.get_uri_args()</span><br><span class="line">local productId = uri_args[&quot;productId&quot;]</span><br><span class="line">local shopId = uri_args[&quot;shopId&quot;]</span><br><span class="line"></span><br><span class="line">local host = &#123;&quot;192.168.33.61&quot;, &quot;192.168.33.62&quot;&#125;</span><br><span class="line">local hash = ngx.crc32_long(productId)</span><br><span class="line">hash = (hash % 2) + 1  </span><br><span class="line">backend = &quot;http://&quot;..host[hash]</span><br><span class="line"></span><br><span class="line">local requestPath = uri_args[&quot;requestPath&quot;]</span><br><span class="line">requestPath = &quot;/&quot;..requestPath..&quot;?productId=&quot;..productId..&quot;&amp;shopId=&quot;..shopId</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local http = require(&quot;resty.http&quot;)  </span><br><span class="line">local httpc = http.new()  </span><br><span class="line"></span><br><span class="line">local resp, err = httpc:request_uri(backend, &#123;  </span><br><span class="line">    method = &quot;GET&quot;,  </span><br><span class="line">	path = requestPath</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">if not resp then  </span><br><span class="line">    ngx.say(&quot;request error :&quot;, err)  </span><br><span class="line">    return  </span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">ngx.say(resp.body)  </span><br><span class="line">  </span><br><span class="line">httpc:close()</span><br></pre></td></tr></table></figure></p>
<p><code>/export/servers/nginx/sbin/nginx -s reload</code></p>
<h2 id="业务逻辑："><a href="#业务逻辑：" class="headerlink" title="业务逻辑："></a>业务逻辑：</h2><blockquote>
<ol>
<li>应用nginx的lua脚本接收到请求；</li>
<li>获取请求参数中的商品id，以及商品店铺id；</li>
<li>根据商品id和商品店铺id，在nginx本地缓存中尝试获取数据；</li>
<li>如果在nginx本地缓存中没有获取到数据，那么就到redis分布式缓存中获取数据，<br> 如果获取到了数据，还要设置到nginx本地缓存中；</li>
<li>如果缓存数据生产服务没有在redis分布式缓存中没有获取到数据，那么就在自己本地ehcache中获取数据，<br> 返回数据给nginx，也要设置到nginx本地缓存中；</li>
<li>如果ehcache本地缓存都没有数据，那么就需要去原始的服务中拉去数据，该服务会从mysql中查询，<br> 拉去到数据之后，返回给nginx，并重新设置到ehcache和redis中；</li>
<li>nginx最终利用获取到的数据，动态渲染网页模板。</li>
<li>将渲染后的网页模板作为http响应，返回给分发层nginx</li>
</ol>
</blockquote>
<h2 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h2><blockquote>
<p>建议不要用nginx+lua直接去获取redis数据；<br>因为openresty没有太好的redis cluster的支持包，所以建议是发送http请求到缓存数据生产服务，由该服务提供一个http接口；<br>缓存数生产服务可以基于redis cluster api从redis中直接获取数据，并返回给nginx。<br>要使用发送http请求，需下载http相关lua脚本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /home/bigdata/ngnix-test/lualib/resty</span><br><span class="line">wget https://raw.githubusercontent.com/pintsized/lua-resty-http/master/lib/resty/http_headers.lua</span><br><span class="line">wget https://raw.githubusercontent.com/pintsized/lua-resty-http/master/lib/resty/http.lua</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="下载相关lua脚本"><a href="#下载相关lua脚本" class="headerlink" title="下载相关lua脚本:"></a>下载相关lua脚本:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /home/bigdata/ngnix-test/lualib/resty</span><br><span class="line">wget https://raw.githubusercontent.com/bungle/lua-resty-template/master/lib/resty/template.lua</span><br><span class="line"></span><br><span class="line">mkdir -p /home/bigdata/ngnix-test/lualib/resty/html</span><br><span class="line">cd /home/bigdata/ngnix-test/lualib/resty/html</span><br><span class="line"></span><br><span class="line">wget https://raw.githubusercontent.com/bungle/lua-resty-template/master/lib/resty/template/html.lua</span><br></pre></td></tr></table></figure>
<h2 id="配置模板"><a href="#配置模板" class="headerlink" title="配置模板"></a>配置模板</h2><p>在 <code>/home/bigdata/ngnix-test/ngnix-test.conf</code> 的 <code>server</code> 中配置模板位置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /home/bigdata/ngnix-test/ngnix-test.conf</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">set $template_location &quot;/templates&quot;;  </span><br><span class="line">set $template_root &quot;/home/bigdata/ngnix-test/templates&quot;;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/bigdata/ngnix-test/templates</span><br><span class="line">vi /home/bigdata/ngnix-test/templates/product.html</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;</span><br><span class="line">		&lt;title&gt;商品详情页&lt;/title&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">商品id: &#123;* productId *&#125;&lt;br/&gt;</span><br><span class="line">商品名称: &#123;* productName *&#125;&lt;br/&gt;</span><br><span class="line">商品图片列表: &#123;* productPictureList *&#125;&lt;br/&gt;</span><br><span class="line">商品规格: &#123;* productSpecification *&#125;&lt;br/&gt;</span><br><span class="line">商品售后服务: &#123;* productService *&#125;&lt;br/&gt;</span><br><span class="line">商品颜色: &#123;* productColor *&#125;&lt;br/&gt;</span><br><span class="line">商品大小: &#123;* productSize *&#125;&lt;br/&gt;</span><br><span class="line">店铺id: &#123;* shopId *&#125;&lt;br/&gt;</span><br><span class="line">店铺名称: &#123;* shopName *&#125;&lt;br/&gt;</span><br><span class="line">店铺评级: &#123;* shopLevel *&#125;&lt;br/&gt;</span><br><span class="line">店铺好评率: &#123;* shopGoodCommentRate *&#125;&lt;br/&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h2 id="将渲染后的网页模板作为http响应，返回给分发层nginx"><a href="#将渲染后的网页模板作为http响应，返回给分发层nginx" class="headerlink" title="将渲染后的网页模板作为http响应，返回给分发层nginx"></a>将渲染后的网页模板作为http响应，返回给分发层nginx</h2><p><code>/export/servers/nginx/conf/nginx.conf</code> 中添加设置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /export/servers/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">lua_shared_dict my_cache 128m;</span><br></pre></td></tr></table></figure></p>
<p><code>/home/bigdata/ngnix-test/ngnix-test.conf</code> 中添加设置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi /home/bigdata/ngnix-test/ngnix-test.conf</span><br><span class="line">...</span><br><span class="line">	location /product &#123;</span><br><span class="line">		default_type &apos;text/html&apos;;</span><br><span class="line">		content_by_lua_file /home/bigdata/ngnix-test/lua/product.lua;</span><br><span class="line">	&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p><code>/home/bigdata/ngnix-test/lua/product.lua</code> 脚本中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">vi /home/bigdata/ngnix-test/lua/product.lua</span><br><span class="line"></span><br><span class="line">local uri_args = ngx.req.get_uri_args()</span><br><span class="line">local productId = uri_args[&quot;productId&quot;]</span><br><span class="line">local shopId = uri_args[&quot;shopId&quot;]</span><br><span class="line"></span><br><span class="line">local cache_ngx = ngx.shared.my_cache</span><br><span class="line"></span><br><span class="line">local productCacheKey = &quot;product_info_&quot;..productId</span><br><span class="line">local shopCacheKey = &quot;shop_info_&quot;..shopId</span><br><span class="line"></span><br><span class="line">local productCache = cache_ngx:get(productCacheKey)</span><br><span class="line">local shopCache = cache_ngx:get(shopCacheKey)</span><br><span class="line"></span><br><span class="line">if productCache == &quot;&quot; or productCache == nil then</span><br><span class="line">	local http = require(&quot;resty.http&quot;)</span><br><span class="line">	local httpc = http.new()</span><br><span class="line"></span><br><span class="line">	local resp, err = httpc:request_uri(&quot;http://192.168.230.10:8080&quot;,&#123;</span><br><span class="line">  		method = &quot;GET&quot;,</span><br><span class="line">  		path = &quot;/getProductInfo?productId=&quot;..productId</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	productCache = resp.body</span><br><span class="line">	cache_ngx:set(productCacheKey, productCache, 10 * 60)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">if shopCache == &quot;&quot; or shopCache == nil then</span><br><span class="line">	local http = require(&quot;resty.http&quot;)</span><br><span class="line">	local httpc = http.new()</span><br><span class="line"></span><br><span class="line">	local resp, err = httpc:request_uri(&quot;http://192.168.230.10:8080&quot;,&#123;</span><br><span class="line">  		method = &quot;GET&quot;,</span><br><span class="line">  		path = &quot;/getShopInfo?shopId=&quot;..shopId</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	shopCache = resp.body</span><br><span class="line">	cache_ngx:set(shopCacheKey, shopCache, 10 * 60)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">local cjson = require(&quot;cjson&quot;)</span><br><span class="line">local productCacheJSON = cjson.decode(productCache)</span><br><span class="line">local shopCacheJSON = cjson.decode(shopCache)</span><br><span class="line"></span><br><span class="line">local context = &#123;</span><br><span class="line">	productId = productCacheJSON.id,</span><br><span class="line">	productName = productCacheJSON.name,</span><br><span class="line">	productPrice = productCacheJSON.price,</span><br><span class="line">	productPictureList = productCacheJSON.pictureList,</span><br><span class="line">	productSpecification = productCacheJSON.specification,</span><br><span class="line">	productService = productCacheJSON.service,</span><br><span class="line">	productColor = productCacheJSON.color,</span><br><span class="line">	productSize = productCacheJSON.size,</span><br><span class="line">	shopId = shopCacheJSON.id,</span><br><span class="line">	shopName = shopCacheJSON.name,</span><br><span class="line">	shopLevel = shopCacheJSON.level,</span><br><span class="line">	shopGoodCommentRate = shopCacheJSON.goodCommentRate</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">local template = require(&quot;resty.template&quot;)</span><br><span class="line">template.render(&quot;product.html&quot;, context)</span><br></pre></td></tr></table></figure></p>
<hr>
<p>在两台ngnix应用服务器，根据上面配置，重新部署。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scp /export/servers/nginx/conf/nginx.conf bigdata@bigdata02:/export/servers/nginx/conf/</span><br><span class="line"></span><br><span class="line">scp -r /home/bigdata/ngnix-test/ bigdata@bigdata02:/home/bigdata/</span><br><span class="line"></span><br><span class="line">/export/servers/nginx/sbin/nginx</span><br><span class="line">/export/servers/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure></p>
<p>第一次访问的时候，其实在nginx本地缓存中是取不到的，所以会发送http请求到后端的缓存服务里去获取，会从redis中获取</p>
<p>拿到数据以后，会放到nginx本地缓存里面去，过期时间是10分钟</p>
<p>然后将所有数据渲染到模板中，返回模板</p>
<p>以后再来访问的时候，就会直接从nginx本地缓存区获取数据了</p>
<p>缓存数据生产 -&gt; 有数据变更 -&gt; 主动更新两级缓存（ehcache+redis）-&gt; 缓存维度化拆分</p>
<p>分发层nginx + 应用层nginx -&gt; 自定义流量分发策略提高缓存命中率</p>
<p>nginx shared dict缓存 -&gt; 缓存服务 -&gt; redis -&gt; ehcache -&gt; 渲染html模板 -&gt; 返回页面</p>
<p>还差最后一个很关键的要点，就是如果你的数据在nginx -&gt; redis -&gt; ehcache三级缓存都不在了，可能就是被LRU清理掉了</p>
<p>这个时候缓存服务会重新拉去数据，去更新到ehcache和redis中，这里我们还没讲解</p>
<p>分布式的缓存重建的并发问题</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/27/53-部署分发层nginx以及基于lua完成基于商品id的定向流量分发策略/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/27/53-部署分发层nginx以及基于lua完成基于商品id的定向流量分发策略/" itemprop="url">53-部署分发层nginx以及基于lua完成基于商品id的定向流量分发策略</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-27T13:24:41+08:00">
                2018-12-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>用bigdata01和bigdata02作为应用层nginx服务器，用bigdata03作为分发层nginx。</p>
<p>在bigdata03，也就是分发层nginx中，编写lua脚本，完成基于商品id的流量分发策略。</p>
<p>流量分发策略：</p>
<blockquote>
<ol>
<li>获取请求参数，比如productI；</li>
<li>对productId进行hash；</li>
<li>hash值对应用服务器数量取模，获取到一个应用服务器；</li>
<li>利用http发送请求到应用层nginx；</li>
<li>获取响应后返回；</li>
</ol>
</blockquote>
<p>这个就是基于商品id的定向流量分发的策略，</p>
<p>lua脚本来编写和实现</p>
<p>我们作为一个流量分发的nginx，会发送http请求到后端的应用nginx上面去，所以要先引入lua http lib包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /home/bigdata/ngnix-test/lualib/resty/  </span><br><span class="line">wget https://raw.githubusercontent.com/pintsized/lua-resty-http/master/lib/resty/http_headers.lua</span><br><span class="line">wget https://raw.githubusercontent.com/pintsized/lua-resty-http/master/lib/resty/http.lua</span><br></pre></td></tr></table></figure>
<p>代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">vi /home/bigdata/ngnix-test/lua/ngnix-test.lua</span><br><span class="line"></span><br><span class="line">local uri_args = ngx.req.get_uri_args()</span><br><span class="line">local productId = uri_args[&quot;productId&quot;]</span><br><span class="line"></span><br><span class="line">local host = &#123;&quot;192.168.33.61&quot;, &quot;192.168.33.62&quot;&#125;</span><br><span class="line">local hash = ngx.crc32_long(productId)</span><br><span class="line">hash = (hash % 2) + 1  </span><br><span class="line">backend = &quot;http://&quot;..host[hash]</span><br><span class="line"></span><br><span class="line">local requestPath = uri_args[&quot;requestPath&quot;]</span><br><span class="line">requestPath = &quot;/&quot;..requestPath..&quot;?productId=&quot;..productId</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local http = require(&quot;resty.http&quot;)  </span><br><span class="line">local httpc = http.new()  </span><br><span class="line"></span><br><span class="line">local resp, err = httpc:request_uri(backend, &#123;  </span><br><span class="line">    method = &quot;GET&quot;,  </span><br><span class="line">	path = requestPath</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">if not resp then  </span><br><span class="line">    ngx.say(&quot;request error :&quot;, err)  </span><br><span class="line">    return  </span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">ngx.say(resp.body)  </span><br><span class="line">  </span><br><span class="line">httpc:close()</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/export/servers/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure>
<p>访问 <a href="http://192.168.33.63/ngnix-test?requestPath=ngnix-test&amp;productId=1" target="_blank" rel="noopener">http://192.168.33.63/ngnix-test?requestPath=ngnix-test&amp;productId=1</a></p>
<p>基于商品id的定向流量分发策略的lua脚本就开发完了，而且也测试过了</p>
<p>我们就可以看到，如果你请求的是固定的某一个商品，那么就一定会将流量打到固定的一个应用nginx上面去</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/26/52-基于OpenResty部署应用层nginx以及nginx-lua开发helloworld/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/26/52-基于OpenResty部署应用层nginx以及nginx-lua开发helloworld/" itemprop="url">52-基于OpenResty部署应用层nginx以及nginx-lua开发helloworld</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-26T19:38:25+08:00">
                2018-12-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>1、部署第一个<code>nginx</code>，作为应用层<code>nginx</code>（192.168.332.61那个机器上）</p>
<h2 id="部署OpenResty"><a href="#部署OpenResty" class="headerlink" title="部署OpenResty"></a>部署<code>OpenResty</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#使用root用户安装</span><br><span class="line">yum install -y readline-devel pcre-devel openssl-devel gcc</span><br><span class="line"></span><br><span class="line">#使用bigdata用户安装</span><br><span class="line">cd /home/bigdata/software</span><br><span class="line">wget http://openresty.org/download/openresty-1.13.6.1.tar.gz</span><br><span class="line">tar -zxvf /home/bigdata/software/openresty-1.13.6.1.tar.gz -C /export/servers/</span><br><span class="line"></span><br><span class="line">cd /export/servers/openresty-1.13.6.1/bundle/LuaJIT-2.1-20171103/</span><br><span class="line">make clean &amp;&amp; make &amp;&amp; make install</span><br><span class="line">ln -sf luajit-2.1.0-alpha /usr/local/bin/luajit</span><br><span class="line"></span><br><span class="line">cd /export/servers/openresty-1.13.6.1/bundle </span><br><span class="line">wget https://github.com/FRiCKLE/ngx_cache_purge/archive/2.3.tar.gz</span><br><span class="line">tar -xvf 2.3.tar.gz</span><br><span class="line"></span><br><span class="line">cd /export/servers/openresty-1.13.6.1/bundle</span><br><span class="line">wget https://github.com/yaoweibin/nginx_upstream_check_module/archive/v0.3.0.tar.gz</span><br><span class="line">tar -xvf v0.3.0.tar.gz</span><br><span class="line"></span><br><span class="line">cd /export/servers/openresty-1.13.6.1</span><br><span class="line">./configure --prefix=/export/servers --with-http_realip_module  --with-pcre  --with-luajit --add-module=./bundle/ngx_cache_purge-2.3/ --add-module=./bundle/nginx_upstream_check_module-0.3.0/ -j2</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">cd /export/servers/</span><br><span class="line">ll</span><br><span class="line">#显示有以下结果</span><br><span class="line">/export/servers/luajit</span><br><span class="line">/export/servers/lualib</span><br><span class="line">/export/servers/nginx</span><br><span class="line">/export/servers/nginx/sbin/nginx -V</span><br><span class="line"></span><br><span class="line">#使用root启动nginx，否则会报错</span><br><span class="line">#原因：the socket API bind() to a port less than 1024, such as 80 as your title mentioned, need root access.</span><br><span class="line">/export/servers/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>
<h2 id="nginx-lua开发的hello-world"><a href="#nginx-lua开发的hello-world" class="headerlink" title="nginx+lua开发的hello world"></a><code>nginx+lua</code>开发的<code>hello world</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /export/servers/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure>
<p>在<code>http</code>部分添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">lua_package_path &quot;/export/servers/lualib/?.lua;;&quot;;</span><br><span class="line">lua_package_cpath &quot;/export/servers/lualib/?.so;;&quot;;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>/export/servers/nginx/conf</code>下，创建一个<code>lua.conf</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/nginx/conf</span><br><span class="line">vi lua.conf</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name _;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在<code>nginx.conf</code>的<code>http</code>部分添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /export/servers/nginx/conf/nginx.conf</span><br><span class="line">include lua.conf;</span><br></pre></td></tr></table></figure></p>
<p>验证配置是否正确：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#使用root用户执行</span><br><span class="line">/export/servers/nginx/sbin/nginx -t</span><br></pre></td></tr></table></figure></p>
<p>在<code>lua.conf</code>的<code>server</code>部分添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vi /export/servers/nginx/conf/lua.conf</span><br><span class="line">	location /lua &#123;</span><br><span class="line">	default_type &apos;text/html&apos;;</span><br><span class="line">	content_by_lua &apos;ngx.say(&quot;hello world&quot;)&apos;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#使用root用户执行</span><br><span class="line">/export/servers/nginx/sbin/nginx -t</span><br></pre></td></tr></table></figure></p>
<p>重新<code>nginx</code>加载配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/export/servers/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure></p>
<p>访问 <a href="http://192.168.33.61/lua" target="_blank" rel="noopener">http://192.168.33.61/lua</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/nginx/conf/lua/</span><br><span class="line">vi test.lua</span><br><span class="line"></span><br><span class="line">ngx.say(&quot;hello world&quot;);</span><br></pre></td></tr></table></figure></p>
<p>修改<code>lua.conf</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /export/servers/nginx/conf/lua.conf</span><br><span class="line">	location /lua &#123;</span><br><span class="line">		default_type &apos;text/html&apos;;</span><br><span class="line">		content_by_lua_file conf/lua/test.lua; </span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>查看异常日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f /export/servers/nginx/logs/error.log</span><br></pre></td></tr></table></figure></p>
<h2 id="工程化的nginx-lua项目结构"><a href="#工程化的nginx-lua项目结构" class="headerlink" title="工程化的nginx+lua项目结构"></a>工程化的<code>nginx+lua</code>项目结构</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/bigdata/ngnix-test</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#修改nginx.conf 把user 改成有权限的用户（当前用户）</span><br><span class="line">#否则会报nginx_bug（1）：failed to load external Lua file &quot;xxxx.lua&quot;: cannot open xxxx.lua: Permission denied 错误</span><br><span class="line">vi /export/servers/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">#user nobody;</span><br><span class="line"># 改成 --&gt; user [用户名].根据实际情况修改</span><br><span class="line">user bigdata</span><br></pre></td></tr></table></figure>
<p>项目工程结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ngnix-test</span><br><span class="line">    ngnix-test.conf     </span><br><span class="line">    lua              </span><br><span class="line">		ngnix-test.lua</span><br><span class="line">    lualib            </span><br><span class="line">		*.lua</span><br><span class="line">		*.so</span><br></pre></td></tr></table></figure>
<p>放在<code>/home/bigdata/ngnix-test</code>目录下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">vi /export/servers/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">	lua_package_path &quot;/home/bigdata/ngnix-test/lualib/?.lua;;&quot;;</span><br><span class="line">	lua_package_cpath &quot;/home/bigdata/ngnix-test/lualib/?.so;;&quot;;</span><br><span class="line">	include /home/bigdata/ngnix-test/ngnix-test.conf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cd /home/bigdata/ngnix-test/</span><br><span class="line">vi ngnix-test.conf</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;  </span><br><span class="line">    server_name  _;</span><br><span class="line"></span><br><span class="line">	location /ngnix-test &#123;</span><br><span class="line">		default_type &apos;text/html&apos;;</span><br><span class="line">		content_by_lua_file /home/bigdata/ngnix-test/lua/ngnix-test.lua;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mkdir -p /home/bigdata/ngnix-test/lua</span><br><span class="line">cd /home/bigdata/ngnix-test/lua</span><br><span class="line">vi ngnix-test.lua</span><br><span class="line"></span><br><span class="line">ngx.say(&quot;hello world&quot;);</span><br><span class="line"></span><br><span class="line">mkdir -p /home/bigdata/ngnix-test/lualib</span><br><span class="line">cp -r /export/servers/lualib/ /home/bigdata/ngnix-test/</span><br><span class="line"></span><br><span class="line">#使用root用户执行</span><br><span class="line">/export/servers/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure></p>
<p>访问 <a href="http://192.168.33.61/ngnix-test" target="_blank" rel="noopener">http://192.168.33.61/ngnix-test</a></p>
<h2 id="如法炮制，在其余机器上，也用OpenResty部署一个nginx"><a href="#如法炮制，在其余机器上，也用OpenResty部署一个nginx" class="headerlink" title="如法炮制，在其余机器上，也用OpenResty部署一个nginx"></a>如法炮制，在其余机器上，也用<code>OpenResty</code>部署一个<code>nginx</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -r /home/bigdata/ngnix-test/ bigdata@192.168.33.63:/home/bigdata/</span><br><span class="line">scp -r /export/servers/nginx/conf/nginx.conf bigdata@192.168.33.63:/export/servers/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/26/51-基于-分发层-应用层双层nginx架构提升缓存命中率方案分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/26/51-基于-分发层-应用层双层nginx架构提升缓存命中率方案分析/" itemprop="url">51-基于-分发层-应用层双层nginx架构提升缓存命中率方案分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-26T18:45:43+08:00">
                2018-12-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="缓存命中率低"><a href="#缓存命中率低" class="headerlink" title="缓存命中率低"></a>缓存命中率低</h2><p>部署多个nginx，在里面都会放一些缓存，就默认情况下，此时缓存命中率是比较低的。</p>
<h2 id="如何提升缓存命中率"><a href="#如何提升缓存命中率" class="headerlink" title="如何提升缓存命中率"></a>如何提升缓存命中率</h2><p>分发层 + 应用层，双层nginx</p>
<ol>
<li>分发层<br>分发层nginx，负责流量分发的逻辑和策略，这个里面它可以根据你自己定义的一些规则，比如根据productId去进行hash，然后对后端的nginx数量取模。</li>
</ol>
<p>将某一个商品的访问的请求，就固定路由到一个nginx后端服务器上去，保证说只会从redis中获取一次缓存数据，后面全都是走nginx本地缓存了。</p>
<ol>
<li>应用层<br>后端的nginx服务器，就称之为应用服务器; 最前端的nginx服务器，被称之为分发服务器。</li>
</ol>
<p>看似很简单，其实很有用，在实际的生产环境中，可以大幅度提升你的nginx本地缓存这一层的命中率，大幅度减少redis后端的压力，提升性能。</p>
<p><img src="/2018/12/26/51-基于-分发层-应用层双层nginx架构提升缓存命中率方案分析/缓存命中率低的原因.png" alt="缓存命中率低的原因"></p>
<p><img src="/2018/12/26/51-基于-分发层-应用层双层nginx架构提升缓存命中率方案分析/分发层-应用层双层nginx架构.png" alt="分发层-应用层双层nginx架构"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/26/50-基于kafka-ehcache-redis完成缓存数据生产服务的开发与测试/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/26/50-基于kafka-ehcache-redis完成缓存数据生产服务的开发与测试/" itemprop="url">50-基于kafka-ehcache-redis完成缓存数据生产服务的开发与测试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-26T14:25:26+08:00">
                2018-12-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="kafka相关配置"><a href="#kafka相关配置" class="headerlink" title="kafka相关配置"></a>kafka相关配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /export/servers/kafka/config/server.properties</span><br><span class="line"></span><br><span class="line">#远程消费的话，配置此参数</span><br><span class="line">listeners=PLAINTEXT://192.168.33.61:9092</span><br></pre></td></tr></table></figure>
<h2 id="kafka测试命令"><a href="#kafka测试命令" class="headerlink" title="kafka测试命令"></a>kafka测试命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#生成cache-message主题</span><br><span class="line">kafka-topics.sh --create --zookeeper bigdata01:2181 --replication-factor 3 --partitions 3 --topic cache-message</span><br><span class="line"></span><br><span class="line">#查看cache-message的详情</span><br><span class="line">kafka-topics.sh --topic cache-message --describe --zookeeper bigdata01:2181</span><br><span class="line"></span><br><span class="line">#生产数据</span><br><span class="line">#注意事项，要远程消费数据，配置/export/servers/kafka/config/server.properties中listeners=PLAINTEXT://192.168.33.61:9092</span><br><span class="line">kafka-console-producer.sh --broker-list bigdata01:9092,bigdata02:9092,bigdata03:9092 --topic cache-message</span><br><span class="line">kafka-console-producer.sh --bootstrap-server 192.168.33.61:9092,192.168.33.62:9092,192.168.33.63:9092 --topic cache-message</span><br><span class="line"></span><br><span class="line">#往console输入数据</span><br><span class="line">&#123;&quot;serviceId&quot;: &quot;productInfoService&quot;, &quot;productId&quot;: 5&#125;</span><br><span class="line">&#123;&quot;serviceId&quot;: &quot;shopInfoService&quot;, &quot;shopId&quot;: 1&#125;</span><br><span class="line"></span><br><span class="line">#停止kafka</span><br><span class="line">kafka-server-stop.sh</span><br></pre></td></tr></table></figure>
<h2 id="代码注意点"><a href="#代码注意点" class="headerlink" title="代码注意点"></a>代码注意点</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Properties props = new Properties();</span><br><span class="line">// 确保 rebalance.max.retries * rebalance.backoff.ms &gt; zookeeper.session.timeout.ms</span><br><span class="line">props.put(&quot;zookeeper.connect&quot;, &quot;192.168.33.61:2181,192.168.33.62:2181,192.168.33.63:2181&quot;);</span><br><span class="line">props.put(&quot;group.id&quot;, &quot;eshop-cache-group&quot;);</span><br><span class="line">props.put(&quot;zookeeper.session.timeout.ms&quot;, &quot;40000&quot;);</span><br><span class="line">props.put(&quot;zookeeper.connection.timeout.ms&quot;, &quot;40000&quot;);</span><br><span class="line">props.put(&quot;zookeeper.sync.time.ms&quot;, &quot;200&quot;);</span><br><span class="line">props.put(&quot;rebalance.backoff.ms&quot;, &quot;20000&quot;);</span><br><span class="line">props.put(&quot;rebalance.max.retries&quot;, &quot;10&quot;);</span><br><span class="line">props.put(&quot;auto.commit.interval.ms&quot;, &quot;1000&quot;);</span><br><span class="line">return new ConsumerConfig(props);</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/25/49-zookeeper-kafka集群的安装部署以及如何简单使用的介绍/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/25/49-zookeeper-kafka集群的安装部署以及如何简单使用的介绍/" itemprop="url">49-zookeeper-kafka集群的安装部署以及如何简单使用的介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-25T19:49:40+08:00">
                2018-12-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="zookeeper集群搭建"><a href="#zookeeper集群搭建" class="headerlink" title="zookeeper集群搭建"></a>zookeeper集群搭建</h1><h2 id="解压文件"><a href="#解压文件" class="headerlink" title="解压文件"></a>解压文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf /home/bigdata/software/zookeeper-3.4.11.tar.gz -C /export/servers/</span><br><span class="line">cd /export/servers/</span><br><span class="line">ln -s zookeeper-3.4.11 zookeeper</span><br></pre></td></tr></table></figure>
<h2 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h2><h3 id="修改zookeeper数据目录和日志目录"><a href="#修改zookeeper数据目录和日志目录" class="headerlink" title="修改zookeeper数据目录和日志目录"></a>修改zookeeper数据目录和日志目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/zookeeper/conf</span><br><span class="line">cp zoo_sample.cfg zoo.cfg</span><br><span class="line">vi /export/servers/zookeeper/conf/zoo.cfg</span><br><span class="line"></span><br><span class="line">#zookeeper数据目录</span><br><span class="line">dataDir=/export/data/zookeeper/workdir/data</span><br><span class="line"></span><br><span class="line">#zookeeper日志目录</span><br><span class="line">dataLogDir=/export/data/zookeeper/workdir/log</span><br></pre></td></tr></table></figure>
<h3 id="设置zookeeper集群信息"><a href="#设置zookeeper集群信息" class="headerlink" title="设置zookeeper集群信息"></a>设置zookeeper集群信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vi /export/servers/zookeeper/conf/zoo.cfg</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">#设置集群信息,此处的bigdata0x可以用ip地址代替</span><br><span class="line">server.1=bigdata01:2888:3888</span><br><span class="line">server.2=bigdata02:2888:3888</span><br><span class="line">server.3=bigdata03:2888:3888</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#执行</span><br><span class="line">rm -rf /export/data/zookeeper/</span><br><span class="line"></span><br><span class="line">mkdir -p /export/data/zookeeper/workdir/data</span><br><span class="line">mkdir -p /export/data/zookeeper/workdir/log</span><br><span class="line"></span><br><span class="line">echo &quot;1&quot; &gt; /export/data/zookeeper/workdir/data/myid</span><br></pre></td></tr></table></figure>
<h3 id="将zookeeper拷贝到其它机器上"><a href="#将zookeeper拷贝到其它机器上" class="headerlink" title="将zookeeper拷贝到其它机器上"></a>将zookeeper拷贝到其它机器上</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#将zookeeper拷贝至bigdata02机器上</span><br><span class="line">scp -r /export/servers/zookeeper-3.4.11 bigdata@bigdata02:/export/servers</span><br><span class="line"></span><br><span class="line">#进入bigdata02机器执行以下命令</span><br><span class="line">mkdir -p /export/data/zookeeper/workdir/data</span><br><span class="line">echo &quot;2&quot; &gt; /export/data/zookeeper/workdir/data/myid</span><br><span class="line"></span><br><span class="line">#将zookeeper拷贝至bigdata03机器上</span><br><span class="line">scp -r /export/servers/zookeeper-3.4.11 bigdata@bigdata03:/export/servers</span><br><span class="line"></span><br><span class="line">#进入bigdata03机器执行以下命令</span><br><span class="line">mkdir -p /export/data/zookeeper/workdir/data</span><br><span class="line">echo &quot;3&quot; &gt; /export/data/zookeeper/workdir/data/myid</span><br></pre></td></tr></table></figure>
<h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#切换成root用户执行，修改profile文件</span><br><span class="line">vi /etc/profile</span><br><span class="line">#Zookeeper</span><br><span class="line">export ZOOKEEPER_HOME=/export/servers/zookeeper</span><br><span class="line">export PATH=$PATH:$&#123;ZOOKEEPER_HOME&#125;/bin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#使配置生效</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<h2 id="zk命令"><a href="#zk命令" class="headerlink" title="zk命令"></a>zk命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#启动时，切换成bigdata用户</span><br><span class="line">su bigdata</span><br><span class="line"></span><br><span class="line">#启动zookeeper</span><br><span class="line">zkServer.sh start</span><br><span class="line"></span><br><span class="line">#查看zookeeper状态</span><br><span class="line">zkServer.sh status</span><br></pre></td></tr></table></figure>
<h1 id="kafka集群搭建"><a href="#kafka集群搭建" class="headerlink" title="kafka集群搭建"></a>kafka集群搭建</h1><p>搭建kafka集群前，先保证zookeeper集群已搭建成功。</p>
<h2 id="解压文件-1"><a href="#解压文件-1" class="headerlink" title="解压文件"></a>解压文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf /home/bigdata/software/kafka_2.11-1.0.0.tgz -C /export/servers/</span><br><span class="line">cd /export/servers/</span><br><span class="line">ln -s kafka_2.11-1.0.0 kafka</span><br></pre></td></tr></table></figure>
<h2 id="修改配置-1"><a href="#修改配置-1" class="headerlink" title="修改配置"></a>修改配置</h2><h3 id="修改zookeeper数据目录和日志目录-1"><a href="#修改zookeeper数据目录和日志目录-1" class="headerlink" title="修改zookeeper数据目录和日志目录"></a>修改zookeeper数据目录和日志目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">cp /export/servers/kafka/config/server.properties /export/servers/kafka/config/server.properties.bak</span><br><span class="line">vi /export/servers/kafka/config/server.properties</span><br><span class="line"></span><br><span class="line">#根据实际情况修改</span><br><span class="line">#当前机器在集群中的唯一标识，和zookeeper的myid性质一样</span><br><span class="line">broker.id=0</span><br><span class="line"></span><br><span class="line">#当前kafka对外提供服务的端口默认是9092</span><br><span class="line">port=9092</span><br><span class="line"></span><br><span class="line">#这个参数默认是关闭的，在0.8.1有个bug，DNS解析问题，失败率的问题。</span><br><span class="line">host.name=192.168.33.61</span><br><span class="line"></span><br><span class="line">#这个是borker进行网络处理的线程数</span><br><span class="line">num.network.threads=3</span><br><span class="line"></span><br><span class="line">#这个是borker进行I/O处理的线程数</span><br><span class="line">num.io.threads=8</span><br><span class="line"></span><br><span class="line">#消息存放的目录，这个目录可以配置为&quot;,&quot;逗号分割的表达式，</span><br><span class="line">#上面的num.io.threads要大于这个目录的个数这个目录，</span><br><span class="line">#如果配置多个目录，新创建的topic他把消息持久化的地方是，当前以逗号分割的目录中，那个分区数最少就放那一个</span><br><span class="line">log.dirs=/export/data/kafka/logs</span><br><span class="line"></span><br><span class="line">#发送缓冲区buffer大小，数据不是一下子就发送的，先回存储到缓冲区了到达一定的大小后在发送，能提高性能</span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line"></span><br><span class="line">#kafka接收缓冲区大小，当数据到达一定大小后在序列化到磁盘</span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line"></span><br><span class="line">#这个参数是向kafka请求消息或者向kafka发送消息的请请求的最大数，这个值不能超过java的堆栈大小</span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line"></span><br><span class="line">#默认的分区数，一个topic默认1个分区数</span><br><span class="line">num.partitions=1</span><br><span class="line"></span><br><span class="line">#默认消息的最大持久化时间，168小时，7天</span><br><span class="line">log.retention.hours=168</span><br><span class="line"></span><br><span class="line">#消息保存的最大值5M</span><br><span class="line">message.max.byte=5242880</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#kafka保存消息的副本数，如果一个副本失效了，另一个还可以继续提供服务</span><br><span class="line">default.replication.factor=2</span><br><span class="line"></span><br><span class="line">#取消息的最大直接数</span><br><span class="line">replica.fetch.max.bytes=5242880</span><br><span class="line"></span><br><span class="line">#这个参数是：因为kafka的消息是以追加的形式落地到文件，当超过这个值的时候，kafka会新起一个文件</span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line"></span><br><span class="line">#每隔300000毫秒去检查上面配置的log失效时间（log.retention.hours=168 ），</span><br><span class="line">#到目录查看是否有过期的消息如果有，删除</span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line"></span><br><span class="line">#是否启用log压缩，一般不用启用，启用的话可以提高性能</span><br><span class="line">log.cleaner.enable=false</span><br><span class="line"></span><br><span class="line">#设置zookeeper的连接端口</span><br><span class="line">zookeeper.connect=bigdata01:2181,bigdata02:2181,bigdata03:2181</span><br><span class="line"></span><br><span class="line">#远程消费的话，配置此参数</span><br><span class="line">listeners=PLAINTEXT://192.168.33.61:9092</span><br></pre></td></tr></table></figure>
<h2 id="分发安装包"><a href="#分发安装包" class="headerlink" title="分发安装包"></a>分发安装包</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#将kafka安装包分发到其它机器上</span><br><span class="line">scp -r /export/servers/kafka_2.11-1.0.0 bigdata@bigdata02:/export/servers</span><br><span class="line">scp -r /export/servers/kafka_2.11-1.0.0 bigdata@bigdata03:/export/servers</span><br><span class="line"></span><br><span class="line">#然后分别在各机器上创建软连</span><br><span class="line">cd /export/servers/</span><br><span class="line">ln -s kafka_2.11-1.0.0 kafka</span><br></pre></td></tr></table></figure>
<h2 id="修改其它机器上的kafka配置"><a href="#修改其它机器上的kafka配置" class="headerlink" title="修改其它机器上的kafka配置"></a>修改其它机器上的kafka配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#修改其它机器的kafka配置信息</span><br><span class="line">vi /export/servers/kafka/config/server.properties</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">将broker.id的值，修改成相应的数字</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="添加环境变量"><a href="#添加环境变量" class="headerlink" title="添加环境变量"></a>添加环境变量</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#切换成root用户执行，修改profile文件</span><br><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line">#Kafka</span><br><span class="line">export KAFKA_HOME=/export/servers/kafka</span><br><span class="line">export PATH=$PATH:$KAFKA_HOME/bin</span><br><span class="line"></span><br><span class="line">#使配置生效</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<h2 id="kafka命令"><a href="#kafka命令" class="headerlink" title="kafka命令"></a>kafka命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#依次在各节点上启动kafka</span><br><span class="line">kafka-server-start.sh /export/servers/kafka/config/server.properties &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">#停止kafka</span><br><span class="line">kafka-server-stop.sh</span><br><span class="line"></span><br><span class="line">#查看当前服务器中的所有topic</span><br><span class="line">kafka-topics.sh --list --zookeeper bigdata01:2181</span><br><span class="line"></span><br><span class="line">#创建topic</span><br><span class="line">kafka-topics.sh --create --zookeeper bigdata01:2181 --replication-factor 3 --partitions 3 --topic test</span><br><span class="line"></span><br><span class="line">#删除topic</span><br><span class="line">kafka-topics.sh --delete --zookeeper bigdata01:2181 --topic test</span><br><span class="line">需要server.properties中设置delete.topic.enable=true否则只是标记删除或者直接重启。</span><br><span class="line"></span><br><span class="line">#通过shell命令发送消息</span><br><span class="line">kafka-console-producer.sh --broker-list bigdata01:9092 --topic test</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#通过shell消费消息</span><br><span class="line">kafka-console-consumer.sh --zookeeper bigdata01:2181 --from-beginning --topic test</span><br><span class="line"></span><br><span class="line">#查看消费位置</span><br><span class="line">kafka-run-class.sh kafka.tools.ConsumerOffsetChecker --zookeeper bigdata01:2181 --group testGroup</span><br><span class="line"></span><br><span class="line">#查看某个Topic的详情</span><br><span class="line">kafka-topics.sh --topic test --describe --zookeeper bigdata01:2181</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/25/48-redis的LRU缓存清除算法讲解以及相关配置使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/25/48-redis的LRU缓存清除算法讲解以及相关配置使用/" itemprop="url">48-redis的LRU缓存清除算法讲解以及相关配置使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-25T13:40:29+08:00">
                2018-12-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>如果不断地将数据写入<code>redis</code>，然而<code>redis</code>的内存是有限的，每个<code>redis</code>实例最大一般也就是设置给<code>10G</code>。</p>
<p>那如果不断地写入数据，当数据写入的量超过了<code>redis</code>能承受的范围之后，该怎么玩儿呢？？？</p>
<p><code>redis</code>是会在数据量超过一个最大的限度之后，就会将数据进行清理，从内存中清理掉一些数据。</p>
<p>只有清理掉一些数据之后，才能将新的数据写入内存中。</p>
<h2 id="LRU算法概述"><a href="#LRU算法概述" class="headerlink" title="LRU算法概述"></a>LRU算法概述</h2><p><code>redis</code>默认情况下使用LRU策略的，因为内存是有限的，但是如果不断地往<code>redis</code>里面写入数据，那肯定是没法将所有的数据存放在内存的。</p>
<p>所以<code>redis</code>默认情况下，当内存中写入的数据很满之后，就会使用<code>LRU</code>算法清理掉内存部分中的数据，腾出一些空间来，然后让新的数据写入<code>redis</code>缓存中。</p>
<p><code>LRU：Least Recently Used</code>：最近最少使用算法</p>
<p>将最近一段时间内，最少使用的一些数据，给干掉。比如说有一个key，在最近1个小时内，只被访问了一次; 还有一个key在最近1个小时内，被访问了1万次。</p>
<p>这个时候比如你要将部分数据给清理掉，你会选择清理哪些数据啊？肯定是那个在最近小时内被访问了1万次的数据。</p>
<h2 id="缓存清理设置"><a href="#缓存清理设置" class="headerlink" title="缓存清理设置"></a>缓存清理设置</h2><p><code>redis.conf</code>配置文件设置。</p>
<p><code>maxmemory</code>：设置<code>redis</code>用来存放数据的最大的内存大小，一旦超出这个内存大小之后，就会立即使用LRU算法清理掉部分数据。</p>
<p>如果用<code>LRU</code>，那么就是将最近最少使用的数据从缓存中清除出去。</p>
<p>对于64 bit的机器，如果<code>maxmemory</code>设置为0，那么就默认不限制内存的使用，直到耗尽机器中所有的内存为止; 但是对于32 bit的机器，有一个隐式的闲置就是3GB。</p>
<p><code>maxmemory-policy</code>，可以设置内存达到最大闲置后，采取什么策略来处理。</p>
<blockquote>
<ol>
<li><code>noeviction</code>: 如果内存使用达到了<code>maxmemory</code>，<code>client</code>还要继续写入数据，那么就直接报错给客户端；</li>
<li>allkeys-lru: 就是我们常说的LRU算法，移除掉最近最少使用的那些keys对应的数据；</li>
<li>volatile-lru: 也是采取LRU算法，但是仅仅针对那些设置了指定存活时间（TTL）的key才会清理掉；</li>
<li>allkeys-random: 随机选择一些key来删除掉；</li>
<li>volatile-random: 随机选择一些设置了TTL的key来删除掉；</li>
<li>volatile-ttl: 移除掉部分keys，选择那些TTL时间比较短的keys；</li>
</ol>
</blockquote>
<p>在<code>redis</code>里面，写入<code>key-value</code>对的时候，是可以设置TTL，存活时间，比如你设置了60s，那么一个key-value对，在60s之后就会自动被删除。</p>
<p>redis的使用，各种数据结构，list，set，等等</p>
<p>redis，给了这么多种乱七八糟的缓存清理的算法，其实真正常用的可能也就那么一两种，allkeys-lru是最常用的。</p>
<h2 id="缓存清理的流程"><a href="#缓存清理的流程" class="headerlink" title="缓存清理的流程"></a>缓存清理的流程</h2><blockquote>
<ol>
<li>客户端执行数据写入操作；</li>
<li>redis server接收到写入操作之后，检查maxmemory的限制，如果超过了限制，那么就根据对应的policy清理掉部分数据；</li>
<li>写入操作完成执行；</li>
</ol>
</blockquote>
<h2 id="redis的LRU近似算法"><a href="#redis的LRU近似算法" class="headerlink" title="redis的LRU近似算法"></a>redis的LRU近似算法</h2><p>科普一个相对来说稍微高级一丢丢的知识点。</p>
<p>redis采取的是LRU近似算法，也就是对keys进行采样，然后在采样结果中进行数据清理</p>
<p>redis 3.0开始，在LRU近似算法中引入了pool机制，表现可以跟真正的LRU算法相当，但是还是有所差距的，不过这样可以减少内存的消耗</p>
<p>redis LRU算法，是采样之后再做LRU清理的，跟真正的、传统、全量的LRU算法是不太一样的</p>
<p>maxmemory-samples，比如5，可以设置采样的大小，如果设置为10，那么效果会更好，不过也会耗费更多的CPU资源</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/03/38-CentOS7安装部署MySQL数据库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/03/38-CentOS7安装部署MySQL数据库/" itemprop="url">38-CentOS7安装部署MySQL数据库</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-03T23:26:10+08:00">
                2018-12-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.cnblogs.com/golerun/archive/2018/04/04/8710235.html" target="_blank" rel="noopener">Centos7 Yum方式安装Mysql7</a></p>
<p>安装命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm</span><br><span class="line">rpm -ivh mysql-community-release-el7-5.noarch.rpm</span><br><span class="line"></span><br><span class="line">yum install -y mysql-server</span><br><span class="line">service mysqld start</span><br><span class="line">chkconfig mysqld on</span><br><span class="line">yum install -y mysql-connector-java</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/03/37-高并发场景下的缓存-数据库双写不一致问题分析与解决方案设计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/03/37-高并发场景下的缓存-数据库双写不一致问题分析与解决方案设计/" itemprop="url">37-高并发场景下的缓存+数据库双写不一致问题分析与解决方案设计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-03T16:47:59+08:00">
                2018-12-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="数据库与缓存双写不一致问题及其解决方案"><a href="#数据库与缓存双写不一致问题及其解决方案" class="headerlink" title="数据库与缓存双写不一致问题及其解决方案"></a>数据库与缓存双写不一致问题及其解决方案</h1><h2 id="最初级的缓存不一致问题以及解决方案"><a href="#最初级的缓存不一致问题以及解决方案" class="headerlink" title="最初级的缓存不一致问题以及解决方案"></a>最初级的缓存不一致问题以及解决方案</h2><p><strong>问题：</strong></p>
<blockquote>
<p>先修改数据库，再删除缓存。如果删除缓存失败了，那么会导致数据库中是新数据，缓存中是旧数据，数据出现不一致。</p>
</blockquote>
<p><img src="/2018/12/03/37-高并发场景下的缓存-数据库双写不一致问题分析与解决方案设计/最初级的数据库+缓存双写不一致问题.png" alt="最初级的数据库+缓存双写不一致问题"></p>
<p><strong>解决思路：</strong></p>
<blockquote>
<p>先删除缓存，再修改数据库。删除缓存成功了，如果修改数据库失败了，那么数据库中是旧数据，缓存中是空的，那么数据不会不一致。因为读的时候缓存没有了，所以读数据库中的旧数据，然后更新到缓存中。</p>
</blockquote>
<p><img src="/2018/12/03/37-高并发场景下的缓存-数据库双写不一致问题分析与解决方案设计/最初级的数据库+缓存双写不一致问题的解决方案.png" alt="最初级的数据库+缓存双写不一致问题的解决方案"></p>
<h2 id="比较复杂的数据不一致问题分析"><a href="#比较复杂的数据不一致问题分析" class="headerlink" title="比较复杂的数据不一致问题分析"></a>比较复杂的数据不一致问题分析</h2><p><strong>问题分析：</strong></p>
<blockquote>
<p>数据发生了变化，先删除缓存，然后修改数据库中的数据。此时还在修改数据，一个请求过来，先去读缓存，发现缓存空了，然后去查询数据库，查到了修改前的旧数据，放到了缓存中。数据变更的程序完成了数据库的修改，完了，数据库和缓存中的数据不一样了。。。。</p>
</blockquote>
<h2 id="为什么上亿流量高并发场景下，缓存会出现这个问题？"><a href="#为什么上亿流量高并发场景下，缓存会出现这个问题？" class="headerlink" title="为什么上亿流量高并发场景下，缓存会出现这个问题？"></a>为什么上亿流量高并发场景下，缓存会出现这个问题？</h2><blockquote>
<p>只有在对一个数据进行并发读写，才可能会出现这种问题。其实你的系统并发量很低，特别是读并发很低，每天访问量就1万次，那么很少会出现上述描述的那种不一致的场景。但问题是，如果每天是上亿的流量，每秒并发读是几万，每秒只要有数据更新的请求，就可能会出现上述的数据库+缓存不一致的情况。系统并发量很大，出现问题是很多的。<br><img src="/2018/12/03/37-高并发场景下的缓存-数据库双写不一致问题分析与解决方案设计/读写并发的时候复杂的数据库+缓存双写不一致的场景.png" alt="读写并发的时候复杂的数据库+缓存双写不一致的场景"></p>
</blockquote>
<h2 id="数据库与缓存更新与读取操作进行异步串行化"><a href="#数据库与缓存更新与读取操作进行异步串行化" class="headerlink" title="数据库与缓存更新与读取操作进行异步串行化"></a>数据库与缓存更新与读取操作进行异步串行化</h2><blockquote>
</blockquote>
<p>更新数据的时候，根据数据的唯一标识，将操作路由之后，发送到一个jvm内部的队列中。</p>
<blockquote>
</blockquote>
<p>读取数据的时候，如果发现数据不在缓存中，那么将重新读取数据+更新缓存的操作，根据唯一标识路由之后，也发送同一个jvm内部的队列中。</p>
<blockquote>
</blockquote>
<p>一个队列对应一个工作线程。</p>
<blockquote>
</blockquote>
<p>每个工作线程串行拿到对应的操作，然后一条一条的执行。</p>
<blockquote>
</blockquote>
<p>这样的话，一个数据变更的操作，先执行，删除缓存，然后再去更新数据库，但是还没完成更新；此时如果一个读请求过来，读到了空的缓存，那么可以先将缓存更新的请求发送到队列中，此时会在队列中积压，然后同步等待缓存更新完成。</p>
<blockquote>
</blockquote>
<p>这里有一个优化点，一个队列中，多个更新缓存请求串在一起是没意义的，因此可以做过滤，如果发现队列中已经有一个更新缓存的请求了，那么就不用再往队列中放更新请求操作，直接等待前面的更新操作请求完成即可。待那个队列对应的工作线程完成了上一个操作的数据库的修改之后，才会去执行下一个操作，也就是缓存更新的操作，此时会从数据库中读取最新的值，然后写入缓存中。</p>
<blockquote>
</blockquote>
<p>如果请求还在等待时间范围内，不断轮询发现可以取到值了，那么就直接返回; 如果请求等待的时间超过一定时长，那么这一次直接从数据库中读取当前的旧值。</p>
<p><img src="/2018/12/03/37-高并发场景下的缓存-数据库双写不一致问题分析与解决方案设计/复杂的数据库+缓存双写一致保障方案.png" alt="复杂的数据库+缓存双写一致保障方案"></p>
<h2 id="高并发场景下，该解决方案要注意的问题"><a href="#高并发场景下，该解决方案要注意的问题" class="headerlink" title="高并发场景下，该解决方案要注意的问题"></a>高并发场景下，该解决方案要注意的问题</h2><ol>
<li><p><strong>读请求长时阻塞</strong></p>
<blockquote>
</blockquote>
<p>由于读请求进行了非常轻度的异步化，所以一定要注意读超时的问题，每个读请求必须在超时时间范围内返回。</p>
<blockquote>
</blockquote>
<p>该解决方案，最大的风险点在于说，可能数据更新很频繁，导致队列中积压了大量更新操作在里面，然后读请求会发生大量的超时，最后导致大量的请求直接走数据库。</p>
<blockquote>
</blockquote>
<p>务必通过一些模拟真实的测试，看看更新数据的频繁是怎样的。</p>
<blockquote>
</blockquote>
<p>另外一点，因为一个队列中，可能会积压针对多个数据项的更新操作，因此需要根据自己的业务情况进行测试，可能需要部署多个服务，每个服务分摊一些数据的更新操作</p>
<blockquote>
</blockquote>
<p>如果一个内存队列里居然会挤压100个商品的库存修改操作，每隔库存修改操作要耗费10ms区完成，那么最后一个商品的读请求，可能等待10 * 100 = 1000ms = 1s后，才能得到数据</p>
<blockquote>
</blockquote>
<p>这个时候就导致读请求的长时阻塞</p>
<blockquote>
</blockquote>
<p>一定要做根据实际业务系统的运行情况，去进行一些压力测试，和模拟线上环境，去看看最繁忙的时候，内存队列可能会挤压多少更新操作，可能会导致最后一个更新操作对应的读请求，会hang多少时间，如果读请求在200ms返回，如果你计算过后，哪怕是最繁忙的时候，积压10个更新操作，最多等待200ms，那还可以的</p>
<blockquote>
</blockquote>
<p>如果一个内存队列可能积压的更新操作特别多，那么你就要加机器，让每个机器上部署的服务实例处理更少的数据，那么每个内存队列中积压的更新操作就会越少</p>
<blockquote>
</blockquote>
<p>其实根据之前的项目经验，一般来说数据的写频率是很低的，因此实际上正常来说，在队列中积压的更新操作应该是很少的</p>
<blockquote>
</blockquote>
<p>针对读高并发，读缓存架构的项目，一般写请求相对读来说，是非常非常少的，每秒的QPS能到几百就不错了</p>
<blockquote>
</blockquote>
<p>一秒，500的写操作，5份，每200ms，就100个写操作</p>
<blockquote>
</blockquote>
<p>单机器，20个内存队列，每个内存队列，可能就积压5个写操作，每个写操作性能测试后，一般在20ms左右就完成</p>
<blockquote>
</blockquote>
<p>那么针对每个内存队列中的数据的读请求，也就最多hang一会儿，200ms以内肯定能返回了</p>
<blockquote>
</blockquote>
<p>写QPS扩大10倍，但是经过刚才的测算，就知道，单机支撑写QPS几百没问题，那么就扩容机器，扩容10倍的机器，10台机器，每个机器20个队列，200个队列</p>
<blockquote>
</blockquote>
<p>大部分的情况下，应该是这样的，大量的读请求过来，都是直接走缓存取到数据的</p>
<blockquote>
</blockquote>
<p>少量情况下，可能遇到读跟数据更新冲突的情况，如上所述，那么此时更新操作如果先入队列，之后可能会瞬间来了对这个数据大量的读请求，但是因为做了去重的优化，所以也就一个更新缓存的操作跟在它后面</p>
<blockquote>
</blockquote>
<p>等数据更新完了，读请求触发的缓存更新操作也完成，然后临时等待的读请求全部可以读到缓存中的数据</p>
</li>
<li><p><strong>读请求并发量过高</strong></p>
<blockquote>
</blockquote>
<p>这里还必须做好压力测试，确保恰巧碰上上述情况的时候，还有一个风险，就是突然间大量读请求会在几十毫秒的延时hang在服务上，看服务能不能抗的住，需要多少机器才能抗住最大的极限情况的峰值</p>
<blockquote>
</blockquote>
<p>但是因为并不是所有的数据都在同一时间更新，缓存也不会同一时间失效，所以每次可能也就是少数数据的缓存失效了，然后那些数据对应的读请求过来，并发量应该也不会特别大</p>
<blockquote>
</blockquote>
<p>按1:99的比例计算读和写的请求，每秒5万的读QPS，可能只有500次更新操作</p>
<blockquote>
</blockquote>
<p>如果一秒有500的写QPS，那么要测算好，可能写操作影响的数据有500条，这500条数据在缓存中失效后，可能导致多少读请求，发送读请求到库存服务来，要求更新缓存</p>
<blockquote>
</blockquote>
<p>一般来说，1:1，1:2，1:3，每秒钟有1000个读请求，会hang在库存服务上，每个读请求最多hang多少时间，200ms就会返回</p>
<blockquote>
</blockquote>
<p>在同一时间最多hang住的可能也就是单机200个读请求，同时hang住</p>
<blockquote>
</blockquote>
<p>单机hang200个读请求，还是ok的</p>
<blockquote>
</blockquote>
<p>1:20，每秒更新500条数据，这500秒数据对应的读请求，会有20 * 500 = 1万</p>
<blockquote>
</blockquote>
<p>1万个读请求全部hang在库存服务上，就死定了</p>
</li>
<li><p><strong>多服务实例部署的请求路由</strong></p>
<blockquote>
</blockquote>
<p>可能这个服务部署了多个实例，那么必须保证说，执行数据更新操作，以及执行缓存更新操作的请求，都通过nginx服务器路由到相同的服务实例上</p>
</li>
</ol>
<p><img src="/2018/12/03/37-高并发场景下的缓存-数据库双写不一致问题分析与解决方案设计/机器级别的请求路由问题.png" alt="机器级别的请求路由问题"></p>
<ol>
<li><strong>热点商品的路由问题，导致请求的倾斜</strong><blockquote>
</blockquote>
万一某个商品的读写请求特别高，全部打到相同的机器的相同的队列里面去了，可能造成某台机器的压力过大<blockquote>
</blockquote>
就是说，因为只有在商品数据更新的时候才会清空缓存，然后才会导致读写并发，所以更新频率不是太高的话，这个问题的影响并不是特别大<blockquote>
</blockquote>
但是的确可能某些机器的负载会高一些</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/03/36-Cache-Aside-Pattern缓存-数据库读写模式的分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/03/36-Cache-Aside-Pattern缓存-数据库读写模式的分析/" itemprop="url">36-Cache-Aside-Pattern缓存+数据库读写模式的分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-03T13:54:28+08:00">
                2018-12-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/2018/12/03/36-Cache-Aside-Pattern缓存-数据库读写模式的分析/cache-aside-pattern.png" alt="cache-aside-pattern"></p>
<h2 id="最经典的缓存-数据库读写的模式，cache-aside-pattern"><a href="#最经典的缓存-数据库读写的模式，cache-aside-pattern" class="headerlink" title="最经典的缓存+数据库读写的模式，cache aside pattern"></a>最经典的缓存+数据库读写的模式，cache aside pattern</h2><ol>
<li><p><strong>Cache Aside Pattern</strong></p>
<ol>
<li><p>读的时候，先读缓存，缓存没有的话，那么就读数据库；然后取出数据后放入缓存，同时返回响应。</p>
</li>
<li><p>更新的时候，先删除缓存，然后再更新数据库。</p>
</li>
</ol>
</li>
<li><p><strong>为什么是删除缓存，而不是更新缓存呢？</strong></p>
</li>
</ol>
<p>原因很简单，很多时候，复杂点的缓存的场景，因为缓存有的时候，不简单是数据库中直接取出来的值</p>
<p>商品详情页的系统，修改库存，只是修改了某个表的某些字段，但是要真正把这个影响的最终的库存计算出来，可能还需要从其他表查询一些数据，然后进行一些复杂的运算，才能最终计算出</p>
<p>现在最新的库存是多少，然后才能将库存更新到缓存中去</p>
<p>比如可能更新了某个表的一个字段，然后其对应的缓存，是需要查询另外两个表的数据，并进行运算，才能计算出缓存最新的值的</p>
<p>更新缓存的代价是很高的</p>
<p>是不是说，每次修改数据库的时候，都一定要将其对应的缓存去更新一份？也许有的场景是这样的，但是对于比较复杂的缓存数据计算的场景，就不是这样了</p>
<p>如果你频繁修改的一个缓存涉及多个表，那么这个缓存会被频繁的更新，频繁的更新缓存</p>
<p>但是问题在于，这个缓存到底会不会被频繁访问到？？？</p>
<p>举个例子，一个缓存涉及的表的字段，在1分钟内就修改了20次，或者是100次，那么缓存更新20次，100次; 但是这个缓存在1分钟内就被读取了1次，有大量的冷数据</p>
<p>28法则，黄金法则，20%的数据，占用了80%的访问量</p>
<p>实际上，如果你只是删除缓存的话，那么1分钟内，这个缓存不过就重新计算一次而已，开销大幅度降低</p>
<p>每次数据过来，就只是删除缓存，然后修改数据库，如果这个缓存，在1分钟内只是被访问了1次，那么只有那1次，缓存是要被重新计算的，用缓存才去算缓存</p>
<p>其实删除缓存，而不是更新缓存，就是一个lazy计算的思想，不要每次都重新做复杂的计算，不管它会不会用到，而是让它到需要被使用的时候再重新计算</p>
<p>mybatis，hibernate，懒加载，思想</p>
<p>查询一个部门，部门带了一个员工的list，没有必要说每次查询部门，都里面的1000个员工的数据也同时查出来啊</p>
<p>80%的情况，查这个部门，就只是要访问这个部门的信息就可以了</p>
<p>先查部门，同时要访问里面的员工，那么这个时候只有在你要访问里面的员工的时候，才会去数据库里面查询1000个员工</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/30/35-亿级流量商品详情页的多级缓存架构以及架构中每一层的意义/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/30/35-亿级流量商品详情页的多级缓存架构以及架构中每一层的意义/" itemprop="url">35-亿级流量商品详情页的多级缓存架构以及架构中每一层的意义</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-30T17:30:00+08:00">
                2018-11-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/2018/11/30/35-亿级流量商品详情页的多级缓存架构以及架构中每一层的意义/三级缓存架构图.png" alt="三级缓存架构图"></p>
<h1 id="1-上亿流量的商品详情页系统的多级缓存架构"><a href="#1-上亿流量的商品详情页系统的多级缓存架构" class="headerlink" title="1. 上亿流量的商品详情页系统的多级缓存架构"></a>1. 上亿流量的商品详情页系统的多级缓存架构</h1><p>很多人以为，做个缓存，其实就是用一下<code>redis</code>，访问一下就可以了，简单的缓存。<br>做复杂的缓存，要支撑电商复杂的场景下的高并发的缓存，遇到的问题，非常非常之多，绝对不是说简单的访问一下<code>redsi</code>就可以了。</p>
<p><strong><em>采用三级缓存：nginx本地缓存+redis分布式缓存+tomcat堆缓存的多级缓存架构</em></strong></p>
<ul>
<li>时效性要求非常高的数据：<strong>库存</strong>。</li>
</ul>
<p>一般来说，库存的显示，都是时效性要求会相对高一些，因为随着商品的不断的交易，库存会不断的变化。</p>
<p>当然，我们就希望当库存变化的时候，尽可能更快将库存显示到页面上去，而不是说等了很长时间，库存才反应到页面上去。</p>
<ul>
<li>时效性要求不高的数据：<strong>商品的基本信息（名称、颜色、版本、规格参数，等等）</strong>。</li>
</ul>
<p>时效性要求不高的数据，就还好，比如说你现在改变了商品的名称，稍微晚个几分钟反应到商品页面上，也还能接受。</p>
<p>商品价格/库存等时效性要求高的数据，而且种类较少，采取相关的服务系统每次发生了变更的时候，直接采取数据库和redis缓存双写的方案，这样缓存的时效性最高。</p>
<p>商品基本信息等时效性不高的数据，而且种类繁多，来自多种不同的系统，采取<strong>MQ异步通知</strong>的方式，写一个数据生产服务，监听MQ消息，然后异步拉取服务的数据，更新tomcat jvm缓存+redis缓存。</p>
<p>nginx+lua脚本做页面动态生成的工作，每次请求过来，优先从nginx本地缓存中提取各种数据，结合页面模板，生成需要的页面。</p>
<p>如果nginx本地缓存过期了，那么就让nginx到redis中去拉取数据，更新到nginx本地。</p>
<p>如果redis中的数据被LRU算法清理掉了，那么就让nginx走http接口到后端的服务中拉取数据。数据生产服务中，先在本地tomcat里的jvm堆缓存中找，ehcache，如果数据也被LRU清理掉了，那么就重新发送请求到源头的服务中去拉取数据，然后再次更新tomcat堆内存缓存+redis缓存，并返回数据给nginx，nginx缓存到本地。</p>
<h1 id="2-多级缓存架构中每一层的意义"><a href="#2-多级缓存架构中每一层的意义" class="headerlink" title="2. 多级缓存架构中每一层的意义"></a>2. 多级缓存架构中每一层的意义</h1><p><strong>nginx本地缓存</strong>，抗的是热数据的高并发访问，一般来说，商品的购买总是有热点的，比如每天购买iphone、nike、海尔等知名品牌的东西的人，总是比较多的。</p>
<p>这些热数据，利用nginx本地缓存，由于经常被访问，所以可以被锁定在nginx的本地缓存内。</p>
<p>大量的热数据的访问，就是经常会访问的那些数据，就会被保留在nginx本地缓存内，那么对这些热数据的大量访问，就直接走nginx就可以了。</p>
<p>那么大量的访问，直接就可以走到nginx就行了，不需要走后续的各种网络开销了。</p>
<p>redis分布式大规模缓存，抗的是很高的离散访问，支撑海量的数据，高并发的访问，高可用的服务。</p>
<p>redis缓存最大量的数据，最完整的数据和缓存，1T+数据; 支撑高并发的访问，QPS最高到几十万; 可用性，非常好，提供非常稳定的服务。</p>
<p>nginx本地内存有限，也就能cache住部分热数据，除了各种iphone、nike等热数据，其他相对不那么热的数据，可能流量会经常走到redis那里。</p>
<p>利用redis cluster的多master写入，横向扩容，1T+以上海量数据支持，几十万的读写QPS，99.99%高可用性，那么就可以抗住大量的离散访问请求。</p>
<p>tomcat jvm堆内存缓存，主要是抗redis大规模灾难的，如果redis出现了大规模的宕机，导致nginx大量流量直接涌入数据生产服务，那么最后的tomcat堆内存缓存至少可以再抗一下，不至于让数据库直接裸奔。</p>
<p>同时tomcat jvm堆内存缓存，也可以抗住redis没有cache住的最后那少量的部分缓存。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/28/28-在项目中重新搭建一套读写分离-高可用-多master的redis-cluster集群/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/28/28-在项目中重新搭建一套读写分离-高可用-多master的redis-cluster集群/" itemprop="url">28-在项目中重新搭建一套读写分离+高可用+多master的redis-cluster集群</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-28T14:56:20+08:00">
                2018-11-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="CentOS安装redis集群提示redis-requires-ruby-version-2-2-2的解决方案"><a href="#CentOS安装redis集群提示redis-requires-ruby-version-2-2-2的解决方案" class="headerlink" title="CentOS安装redis集群提示redis requires ruby version 2.2.2的解决方案"></a>CentOS安装redis集群提示<strong><code>redis requires ruby version 2.2.2</code></strong>的解决方案</h1><ol>
<li><p>安装RVM</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#具体RVM安装命令地址，参考：http://rvm.io/</span><br><span class="line">gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB </span><br><span class="line"></span><br><span class="line">curl -sSL https://get.rvm.io | bash -s stable</span><br><span class="line">source /usr/local/rvm/scripts/rvm</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看rvm库中已知的ruby版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm list known</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装一个ruby版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm install 2.5.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用一个ruby版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm use 2.5.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置默认版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm use 2.5.1 --default</span><br></pre></td></tr></table></figure>
</li>
<li><p>卸载一个已知版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rvm remove 1.8.1</span><br><span class="line">rvm remove 2.3.4</span><br><span class="line">rvm remove 2.4.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看ruby版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby --version</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装redis</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install redis</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h1 id="安装redis集群"><a href="#安装redis集群" class="headerlink" title="安装redis集群"></a>安装<code>redis</code>集群</h1><blockquote>
<p>集群配置3台机器，一台机器配置一主一从。<br>redis的配置文件：<code>/export/data/redis/conf/700*.conf</code><br>redis的持久化文件夹：<code>/export/data/redis/700*</code></p>
</blockquote>
<p><strong>3台机器：</strong></p>
<blockquote>
<p>192.168.33.61<br>192.168.33.62<br>192.168.33.63</p>
</blockquote>
<ol>
<li><p>创建目录<br>在3台机器上执行如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /export/data/redis-cluster</span><br><span class="line">mkdir -p /export/data/redis-cluster-log</span><br><span class="line">mkdir -p /export/data/redis/7001</span><br><span class="line">mkdir -p /export/data/redis/7002</span><br><span class="line">mkdir -p /export/data/redis/7003</span><br><span class="line">mkdir -p /export/data/redis/7004</span><br><span class="line">mkdir -p /export/data/redis/7005</span><br><span class="line">mkdir -p /export/data/redis/7006</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>/export/data/redis-cluster</code>为集群目录<br><code>/export/data/redis-cluster-log</code>为集群日志目录</p>
</blockquote>
</li>
<li><p>准备配置文件<br><strong>在1台机器上执行如下命令，准备好配置文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cp -r /export/servers/redis/redis.conf /export/data/redis/conf/7001.conf</span><br><span class="line">cp -r /export/servers/redis/redis.conf /export/data/redis/conf/7002.conf</span><br><span class="line">cp -r /export/servers/redis/redis.conf /export/data/redis/conf/7003.conf</span><br><span class="line">cp -r /export/servers/redis/redis.conf /export/data/redis/conf/7004.conf</span><br><span class="line">cp -r /export/servers/redis/redis.conf /export/data/redis/conf/7005.conf</span><br><span class="line">cp -r /export/servers/redis/redis.conf /export/data/redis/conf/7006.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置  </p>
</li>
</ol>
<hr>
<p><strong>机器端口分配情况：</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">机器ip</th>
<th>分配的端口号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">192.168.33.61</td>
<td>7001 ~ 7002</td>
</tr>
<tr>
<td style="text-align:left">192.168.33.62</td>
<td>7003 ~ 7004</td>
</tr>
<tr>
<td style="text-align:left">192.168.33.63</td>
<td>7005 ~ 7006</td>
</tr>
</tbody>
</table>
<hr>
<p>根据如下表格，并根据机器ip、端口分配情况，修改<strong><code>/export/data/redis/conf/700*.conf</code></strong>相应配置  </p>
<table>
<thead>
<tr>
<th style="text-align:left">配置项</th>
<th>配置值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">port</td>
<td>700*</td>
<td>设置redis的监听端口号</td>
</tr>
<tr>
<td style="text-align:left">cluster-enabled</td>
<td>yes</td>
<td>开启集群</td>
</tr>
<tr>
<td style="text-align:left">cluster-config-file</td>
<td>/export/data/redis-cluster/nodes-700*.conf</td>
<td>集群配置文件</td>
</tr>
<tr>
<td style="text-align:left">cluster-node-timeout</td>
<td>15000</td>
<td>超时时长</td>
</tr>
<tr>
<td style="text-align:left">daemonize</td>
<td>yes</td>
<td>让redis以daemon进程运行</td>
</tr>
<tr>
<td style="text-align:left">pidfile</td>
<td>/export/data/redis/redis_700*.pid</td>
<td>设置redis的pid文件位置</td>
</tr>
<tr>
<td style="text-align:left">dir</td>
<td>/export/data/redis/700*</td>
<td>设置持久化文件的存储位置</td>
</tr>
<tr>
<td style="text-align:left">logfile</td>
<td>/export/data/redis-cluster-log/700*.log</td>
<td>设置集群日志持久化文件的存储位置</td>
</tr>
<tr>
<td style="text-align:left">bind</td>
<td>192.168.33.6*</td>
<td>设置绑定地址，最好不要绑定127.0.0.1，否则集群启动不起来</td>
</tr>
<tr>
<td style="text-align:left">appendonly</td>
<td>yes</td>
<td>开启AOF功能</td>
</tr>
</tbody>
</table>
<hr>
<p>配置完后，将配置文件分发到另外两台机器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -r /export/servers/redis/700* bigdata@192.168.33.62:/export/data/redis/conf/</span><br><span class="line">scp -r /export/servers/redis/700* bigdata@192.168.33.63:/export/data/redis/conf/</span><br></pre></td></tr></table></figure></p>
<ol>
<li><p>准备生产环境的启动脚本<br>在<code>/etc/init.d</code>目录下，准备6个启动脚本，分别为: <code>redis_7001, redis_7002, redis_7003, redis_7004, redis_7005, redis_7006</code>，在每个启动脚本内，都修改对应的端口号。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"># chkconfig:   2345 90 10</span><br><span class="line"># description:  Redis is a persistent key-value database</span><br><span class="line">#</span><br><span class="line"># Simple Redis init.d script conceived to work on Linux systems</span><br><span class="line"># as it does use of the /proc filesystem.</span><br><span class="line"></span><br><span class="line">#redis服务器监听的端口，根据实际情况修改</span><br><span class="line">REDISPORT=700*</span><br><span class="line">#EXEC=/usr/local/bin/redis-server</span><br><span class="line">#CLIEXEC=/usr/local/bin/redis-cli</span><br><span class="line"></span><br><span class="line">#PIDFILE=/var/run/redis_$&#123;REDISPORT&#125;.pid</span><br><span class="line">#CONF=&quot;/etc/redis/$&#123;REDISPORT&#125;.conf&quot;</span><br><span class="line"></span><br><span class="line">#服务端所处位置，在make install后默认存放于`/usr/local/bin/redis-server`，如果未make install则需要修改该路径，下同。</span><br><span class="line">EXEC=/usr/local/bin/redis-server</span><br><span class="line">#客户端位置</span><br><span class="line">CLIEXEC=/usr/local/bin/redis-cli</span><br><span class="line"></span><br><span class="line">#Redis的PID文件位置</span><br><span class="line">PIDFILE=/export/data/redis/redis_$&#123;REDISPORT&#125;.pid</span><br><span class="line">#配置文件位置，需要修改</span><br><span class="line">CONF=&quot;/export/data/redis/conf/$&#123;REDISPORT&#125;.conf&quot;</span><br><span class="line"></span><br><span class="line">case &quot;$1&quot; in</span><br><span class="line">    start)</span><br><span class="line">        if [ -f $PIDFILE ]</span><br><span class="line">        then</span><br><span class="line">                echo &quot;$PIDFILE exists, process is already running or crashed&quot;</span><br><span class="line">        else</span><br><span class="line">                echo &quot;Starting Redis server...&quot;</span><br><span class="line">                $EXEC $CONF</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        if [ ! -f $PIDFILE ]</span><br><span class="line">        then</span><br><span class="line">                echo &quot;$PIDFILE does not exist, process is not running&quot;</span><br><span class="line">        else</span><br><span class="line">                PID=$(cat $PIDFILE)</span><br><span class="line">                echo &quot;Stopping ...&quot;</span><br><span class="line">                $CLIEXEC -p $REDISPORT shutdown</span><br><span class="line">                while [ -x /proc/$&#123;PID&#125; ]</span><br><span class="line">                do</span><br><span class="line">                    echo &quot;Waiting for Redis to shutdown ...&quot;</span><br><span class="line">                    sleep 1</span><br><span class="line">                done</span><br><span class="line">                echo &quot;Redis stopped&quot;</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &quot;Please use start or stop as first argument&quot;</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>
</li>
<li><p>在3台机器上，启动6个redis实例 </p>
<blockquote>
<p><strong>如果有启动redis实例，先停止实例</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/redis-cli -p 7001 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -p 7002 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -p 7003 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -p 7004 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -p 7005 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -p 7006 shutdown</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>清理集群状态</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /export/data/redis-cluster/*</span><br><span class="line">rm -rf /export/data/redis-cluster-log/*</span><br><span class="line"></span><br><span class="line">rm -rf /export/data/redis/7001/*</span><br><span class="line">rm -rf /export/data/redis/7002/*</span><br><span class="line">rm -rf /export/data/redis/7003/*</span><br><span class="line">rm -rf /export/data/redis/7004/*</span><br><span class="line">rm -rf /export/data/redis/7005/*</span><br><span class="line">rm -rf /export/data/redis/7006/*</span><br><span class="line"></span><br><span class="line">rm -rf /export/data/redis/redis_700*.pid</span><br><span class="line"></span><br><span class="line">#在192.168.33.61机器上执行redis-trib.rb create，所以要在清理192.168.33.61上的配置</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7001 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7001 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7001 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7002 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7002 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7002 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7003 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7003 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7003 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7004 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7004 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7004 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7005 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7005 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7005 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7006 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7006 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7006 cluster reset</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>使用<code>flushall</code>和<code>cluster reset</code>命令，避免出现<code>ERR Slot 0 is already busy (Redis::CommandError)</code>错误</p>
</blockquote>
<blockquote>
<p><strong>192.168.33.61机器执行以下命令：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/redis-server /export/data/redis/conf/7001.conf</span><br><span class="line">/usr/local/bin/redis-server /export/data/redis/conf/7002.conf</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>192.168.33.62机器执行以下命令：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/redis-server /export/data/redis/conf/7003.conf</span><br><span class="line">/usr/local/bin/redis-server /export/data/redis/conf/7004.conf</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>192.168.33.63机器执行以下命令：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/redis-server /export/data/redis/conf/7005.conf</span><br><span class="line">/usr/local/bin/redis-server /export/data/redis/conf/7006.conf</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>查看redis实例启动日志：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /export/data/redis-cluster-log/700*</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>创建集群  </p>
<blockquote>
<p><strong>执行以下命令：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /export/servers/redis/src/redis-trib.rb /usr/local/bin</span><br><span class="line">redis-trib.rb create --replicas 1 192.168.33.61:7001 192.168.33.61:7002 192.168.33.62:7003 192.168.33.62:7004 192.168.33.63:7005 192.168.33.63:7006</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>–replicas 1: 每个master有1个slave</p>
</blockquote>
<blockquote>
<p><strong>如果出现以下错误：</strong><br>[ERR] Not all 16384 slots are covered by nodes，<br>执行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb fix 192.168.33.61:7001</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>查看集群状态：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 192.168.33.61 -c -p 7001 cluster nodes</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>设置开机启动  </p>
<blockquote>
<p>使用root用户执行<br><strong>192.168.33.61机器执行以下命令：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#执行以下命令，设置开机服务自动启动</span><br><span class="line">cd /etc/init.d/</span><br><span class="line">chkconfig redis_7001 on</span><br><span class="line">chkconfig redis_7002 on</span><br><span class="line"></span><br><span class="line">#如果要关闭自动启动，执行以下命令</span><br><span class="line">cd /etc/init.d/</span><br><span class="line">chkconfig redis_7001 off</span><br><span class="line">chkconfig redis_7002 off</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>192.168.33.62机器执行以下命令：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#执行以下命令，设置开机服务自动启动</span><br><span class="line">cd /etc/init.d/</span><br><span class="line">chkconfig redis_7003 on</span><br><span class="line">chkconfig redis_7004 on</span><br><span class="line"></span><br><span class="line">#如果要关闭自动启动，执行以下命令</span><br><span class="line">cd /etc/init.d/</span><br><span class="line">chkconfig redis_7003 off</span><br><span class="line">chkconfig redis_7004 off</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>192.168.33.63机器执行以下命令：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#执行以下命令，设置开机服务自动启动</span><br><span class="line">cd /etc/init.d/</span><br><span class="line">chkconfig redis_7005 on</span><br><span class="line">chkconfig redis_7006 on</span><br><span class="line"></span><br><span class="line">#如果要关闭自动启动，执行以下命令</span><br><span class="line">cd /etc/init.d/</span><br><span class="line">chkconfig redis_7005 off</span><br><span class="line">chkconfig redis_7006 off</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/27/test-env-redis集群搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/27/test-env-redis集群搭建/" itemprop="url">test-env-redis集群搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-27T22:09:55+08:00">
                2018-10-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/usr/local/bin/redis-cli -h 192.168.33.61 -p 7001 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -h 192.168.33.61 -p 7002 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -h 192.168.33.61 -p 7003 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -h 192.168.33.61 -p 7004 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -h 192.168.33.61 -p 7005 shutdown</span><br><span class="line">/usr/local/bin/redis-cli -h 192.168.33.61 -p 7006 shutdown</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mkdir -p /export/data/test-env-redis/redis-cluster</span><br><span class="line">mkdir -p /export/data/test-env-redis/redis-cluster-log</span><br><span class="line">mkdir -p /export/data/test-env-redis/redis/7001</span><br><span class="line">mkdir -p /export/data/test-env-redis/redis/7002</span><br><span class="line">mkdir -p /export/data/test-env-redis/redis/7003</span><br><span class="line">mkdir -p /export/data/test-env-redis/redis/7004</span><br><span class="line">mkdir -p /export/data/test-env-redis/redis/7005</span><br><span class="line">mkdir -p /export/data/test-env-redis/redis/7006</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rm -rf /export/data/test-env-redis/redis-cluster/*</span><br><span class="line">rm -rf /export/data/test-env-redis/redis-cluster-log/*</span><br><span class="line"></span><br><span class="line">rm -rf /export/data/test-env-redis/redis/7001/*</span><br><span class="line">rm -rf /export/data/test-env-redis/redis/7002/*</span><br><span class="line">rm -rf /export/data/test-env-redis/redis/7003/*</span><br><span class="line">rm -rf /export/data/test-env-redis/redis/7004/*</span><br><span class="line">rm -rf /export/data/test-env-redis/redis/7005/*</span><br><span class="line">rm -rf /export/data/test-env-redis/redis/7006/*</span><br><span class="line">rm -rf /export/data/test-env-redis/redis/redis_700*.pid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">redis-cli -h 192.168.33.61 -p 7001 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7001 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7001 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7002 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7002 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7002 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7003 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7003 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7003 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7004 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7004 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7004 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7005 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7005 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7005 cluster reset</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7006 flushdb </span><br><span class="line">redis-cli -h 192.168.33.61 -p 7006 flushall</span><br><span class="line">redis-cli -h 192.168.33.61 -p 7006 cluster reset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/usr/local/bin/redis-server /export/data/test-env-redis/redis/conf/7001.conf</span><br><span class="line">/usr/local/bin/redis-server /export/data/test-env-redis/redis/conf/7002.conf</span><br><span class="line"></span><br><span class="line">/usr/local/bin/redis-server /export/data/test-env-redis/redis/conf/7003.conf</span><br><span class="line">/usr/local/bin/redis-server /export/data/test-env-redis/redis/conf/7004.conf</span><br><span class="line"></span><br><span class="line">/usr/local/bin/redis-server /export/data/test-env-redis/redis/conf/7005.conf</span><br><span class="line">/usr/local/bin/redis-server /export/data/test-env-redis/redis/conf/7006.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat /export/data/test-env-redis/redis-cluster-log/700*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#cp /export/servers/redis/src/redis-trib.rb /usr/local/bin</span><br><span class="line">redis-trib.rb create --replicas 1 192.168.33.61:7001 192.168.33.61:7002 192.168.33.61:7003 192.168.33.61:7004 192.168.33.61:7005 192.168.33.61:7006</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/24/Springboot-mybatis-出现-com-mysql-cj-core-exceptions-InvalidConnectionAttributeException/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/24/Springboot-mybatis-出现-com-mysql-cj-core-exceptions-InvalidConnectionAttributeException/" itemprop="url">Springboot-mybatis-出现 com.mysql.cj.core.exceptions.InvalidConnectionAttributeException...</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-24T21:31:32+08:00">
                2018-10-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">其实这个不是spring boot + mybatis的问题， 其实是为了使MySQL JDBC驱动程序的5.1.33版本与UTC时区配合使用，必须在连接字符串中明确指定serverTimezone。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql://localhost:3306/lovewhf?useUnicode=true&amp;useJDBCCompliantTimezoneShift=true&amp;useLegacyDatetimeCode=false&amp;serverTimezone=UTC</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在这里边明确指定serverTimezone</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/18/SpringBoot-Mybatis关于开启驼峰映射的设置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/18/SpringBoot-Mybatis关于开启驼峰映射的设置/" itemprop="url">SpringBoot-Mybatis关于开启驼峰映射的设置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-18T11:09:03+08:00">
                2018-10-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><p>在application.properties文件中添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mybatis.configuration.map-underscore-to-camel-case=true</span><br></pre></td></tr></table></figure>
</li>
<li><p>在mybatis的配置文件，如mybatis-config.xml中进行配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;!-- 开启驼峰映射 ，为自定义的SQL语句服务--&gt;</span><br><span class="line">    &lt;!--设置启用数据库字段下划线映射到java对象的驼峰式命名属性，默认为false--&gt;  </span><br><span class="line">    &lt;settings&gt;</span><br><span class="line">      &lt;setting name=&quot;mapUnderscoreToCamelCase&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">    &lt;/settings&gt; </span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/01/hexo命令/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="laungcisin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/01/hexo命令/" itemprop="url">hexo命令</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-01T00:00:01+08:00">
                2018-01-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#安装环境</span><br><span class="line">hexo init laungcisin.github.io</span><br><span class="line">cd laungcisin.github.io</span><br><span class="line">npm install</span><br><span class="line"></span><br><span class="line">npm audit fix</span><br><span class="line"></span><br><span class="line">npm install hexo-cli -g</span><br><span class="line">npm install hexo --save</span><br><span class="line"></span><br><span class="line">su</span><br><span class="line">npm install hexo-server</span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">git clone https://github.com/iissnan/hexo-theme-next themes/next</span><br></pre></td></tr></table></figure>
<h2 id="将Hexo博客-部署在Github-Pages上"><a href="#将Hexo博客-部署在Github-Pages上" class="headerlink" title="将Hexo博客 部署在Github Pages上"></a>将Hexo博客 部署在Github Pages上</h2><ol>
<li>创建Github账号</li>
<li>创建Github仓库，Github仓库名为：<code>&lt;Github账号名称&gt;.github.io</code></li>
<li><p>将本地Hexo博客推送到GithubPages</p>
<ol>
<li>安装<code>hexo-deployer-git</code>插件<br> <code>npm install hexo-deployer-git --save</code></li>
<li><p>添加SSH key  </p>
<ul>
<li>创建一个 SSH key 。在命令行（即Git Bash）输入以下命令， 回车三下即可<br>  <code>cd ~/.ssh</code><br>  <code>ssh-keygen -t rsa -C &quot;laungcisin@qq.com&quot;</code></li>
<li>添加到 github。<br>复制密钥文件内容（路径形如~/.ssh/id_rsa.pub），粘贴到New SSH Key即可。<br><code>cat ~/.ssh/id_rsa.pub</code></li>
<li><p>测试是否添加成功。在命令行（即Git Bash）依次输入以下命令，返回“You’ve successfully authenticated”即成功：  </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -T git@github.com</span><br><span class="line">yes</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果报<code>ssh_exchange_identification: read: Connection reset by peer</code>，尝试用以下命令解决</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#编辑文件</span><br><span class="line">vi /etc/hosts.allow</span><br><span class="line"></span><br><span class="line">#追加内容</span><br><span class="line">sshd: ALL</span><br><span class="line"></span><br><span class="line">#重启ssh</span><br><span class="line">service sshd restart</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>修改_config.yml  </p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#hexo显示图片功能</span><br><span class="line">#将post_asset_folder值改成true</span><br><span class="line">post_asset_folder: true</span><br><span class="line">npm install hexo-asset-image --save</span><br><span class="line">npm audit fix</span><br><span class="line"></span><br><span class="line">#创建文章使用hexo n命令</span><br><span class="line">hexo n &quot;文章名&quot;</span><br><span class="line"></span><br><span class="line"># 修改主题</span><br><span class="line">#theme: landscape</span><br><span class="line">theme: next</span><br><span class="line"></span><br><span class="line"># 添加github账号</span><br><span class="line"># Deployment</span><br><span class="line">## Docs: https://hexo.io/docs/deployment.html</span><br><span class="line">deploy:</span><br><span class="line">type: git</span><br><span class="line">repository: git@github.com:&lt;Github账号名称&gt;/&lt;Github账号名称 &gt;.github.io.git</span><br><span class="line">branch: master</span><br></pre></td></tr></table></figure>
</li>
<li><p>推送到GithubPages<br> <code>hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</code></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#本地运行</span><br><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo s</span><br><span class="line"></span><br><span class="line">#浏览器查看</span><br><span class="line">http://192.168.33.61:4000/</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<hr>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#确保之前的步骤都能执行成功</span><br><span class="line"></span><br><span class="line">#部署到github上</span><br><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</span><br><span class="line"></span><br><span class="line">https://laungcisin.github.io/</span><br><span class="line"></span><br><span class="line">yum install curl-devel expat-devel gettext-devel openssl-devel zlib-devel</span><br><span class="line"></span><br><span class="line">git config --global user.email &quot;laungcisin@qq.com&quot;</span><br><span class="line">git config --global user.name &quot;laungcisin&quot;</span><br></pre></td></tr></table></figure>
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">laungcisin</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">30</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">categories</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">laungcisin</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
